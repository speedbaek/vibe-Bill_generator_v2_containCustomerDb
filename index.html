<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŠ¹í—ˆë²•ì¸ í…Œí—¤ë€ | ìŠ¤ë§ˆíŠ¸ ê²¬ì  ì‹œìŠ¤í…œ v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" async></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root { --teheran-navy: #001A35; --teheran-blue: #2563EB; --teheran-light-bg: #F8FAFC; }
        body { font-family: 'Pretendard', sans-serif; background-color: #F8FAFC; color: #334155; }
        
        .admin-sidebar { background: #FFFFFF; border-right: 1px solid #E2E8F0; width: 500px; }
        .field-label { font-size: 10px; font-weight: 700; color: #94A3B8; margin-bottom: 2px; display: block; text-transform: uppercase; }
        .admin-input { width: 100%; border: 1px solid #E2E8F0; border-radius: 4px; padding: 5px 8px; font-size: 12px; outline: none; transition: all 0.2s; }
        .admin-input:focus { border-color: var(--teheran-blue); box-shadow: 0 0 0 2px rgba(37,99,235,0.05); }
        .section-title { font-size: 10px; font-weight: 700; color: #2563EB; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid #E2E8F0; }

        #preview-container { background-color: #F1F5F9; min-height: 100vh; overflow-y: auto; padding: 60px 20px; }
        
        .hero-header { background-color: var(--teheran-navy); padding: 28px 0 0 0; color: white; position: relative; }
        
        .logo-center { 
            font-family: 'Pretendard', sans-serif; 
            font-weight: 900; 
            font-size: 26px; 
            letter-spacing: -0.02em; 
            text-align: center; 
            margin-bottom: 20px; 
        }
        /* [ìˆ˜ì •] ë¡œê³  ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼: ê¸°ë³¸ì€ ìˆ¨ê¹€ */
        .logo-img { height: 35px; margin: 0 auto; display: none; }

        .premium-table th { background-color: var(--teheran-light-bg); color: #64748B; font-size: 11px; font-weight: 600; padding: 10px 16px; border-bottom: 1px solid #E2E8F0; text-transform: uppercase; }
        .premium-table td { padding: 12px 16px; border-bottom: 1px solid #F1F5F9; font-size: 15px; vertical-align: top; }
        
        .col-gov { text-align: right; width: 200px; padding-right: 40px !important; }
        .col-fee { text-align: right; width: 180px; padding-right: 20px !important; }
        
        .bank-table { width: 100%; border-collapse: collapse; background-color: white; border: 1px solid #E2E8F0; }
        .bank-table td { border: 1px solid #E2E8F0; padding: 8px 12px; font-size: 11px; }
        .bank-table td:first-child { background-color: var(--teheran-light-bg); color: #64748B; font-weight: 700; width: 120px; text-align: center; }
        .bank-table td:last-child { color: #334155; font-weight: 500; }

        .catchphrase-container { font-family: 'Pretendard', sans-serif; line-height: 1.2; color: #001A35; }
        .cp-text { font-size: 26px; font-weight: 900; letter-spacing: -0.05em; }

        .seal-wrapper { position: relative; display: inline-block; }
        .official-seal {
            position: absolute;
            width: 60px;
            height: 60px;
            right: -65px;
            top: -32px;
            z-index: 10;
            mix-blend-mode: multiply;
            object-fit: contain;
            display: none;
        }

        .label-left { display: inline-block; width: 35px; opacity: 0.6; }
        .label-right { display: inline-block; width: 65px; opacity: 0.6; }

        /* ëª¨ë°”ì¼: ì¢Œì¸¡/ìš°ì¸¡ ì„¸ë¡œ ë°°ì¹˜, ë‘˜ ë‹¤ ë³´ì´ë„ë¡ */
        @media (max-width: 767px) {
            .admin-sidebar { width: 100%; max-height: none; }
            .admin-sidebar .grid.grid-cols-2 { grid-template-columns: 1fr; }
            #preview-container { padding: 20px 12px 90px; min-height: auto; }
            .premium-table th, .premium-table td { font-size: 13px; padding: 12px 10px; }
            .premium-table .col-gov, .premium-table .col-fee { width: 100px; padding-right: 10px !important; }
            .bank-table td { padding: 10px 12px; font-size: 13px; }
            .field-label { font-size: 12px; }
            .hero-header .logo-center { font-size: 22px; margin-bottom: 16px; }
            .cp-text { font-size: 24px; }
            .official-seal { width: 48px; height: 48px; right: -52px; top: -24px; }
        }

        .print-btn-fixed { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; padding: 12px 16px; background: white; border-top: 1px solid #E2E8F0; box-shadow: 0 -4px 12px rgba(0,0,0,0.08); pointer-events: auto; }
        .print-btn-fixed button { min-height: 48px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; cursor: pointer; user-select: none; }

        @media print {
            @page { margin: 12mm; size: A4; }
            html, body { overflow: visible !important; height: auto !important; min-height: auto !important; }
            body > div, #preview-container, #preview-container > div, .max-w-4xl, .overflow-x-auto { overflow: visible !important; height: auto !important; min-height: auto !important; }
            .no-print, .print-btn-fixed, aside, #mobile-preview-divider { display: none !important; }
            #preview-container { padding: 0 !important; background: white !important; }
            .max-w-4xl { max-width: 56rem !important; box-shadow: none !important; border: none !important; margin: 0 auto !important; padding: 0 !important; min-height: auto !important; }
            .hero-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .logo-img { filter: invert(1); mix-blend-mode: normal !important; }
            /* ì¸ì‡„ ì‹œ PC ë ˆì´ì•„ì›ƒ ê°•ì œ (ìˆ˜ì‹ /ë°œì‹  ì¢Œìš° ë°°ì¹˜) */
            .print-row { flex-direction: row !important; justify-content: space-between !important; align-items: flex-end !important; }
            .print-row-center { align-items: center !important; }
            .print-half { width: 50% !important; }
            .print-row .print-half:last-child { display: flex !important; flex-direction: column !important; align-items: flex-end !important; }
            .print-grid { grid-template-columns: repeat(3, 1fr) !important; }
            .print-grid > div { border-right: 1px solid rgba(255,255,255,0.1) !important; }
            .print-grid > div:last-child { border-right: none !important; }
            .print-total { width: 280px !important; border-top: none !important; border-left: 1px solid #E2E8F0 !important; padding-top: 0 !important; padding-left: 1.5rem !important; }
            .print-bank { flex-direction: row !important; justify-content: space-between !important; align-items: flex-end !important; }
            .print-bank-left { width: auto !important; flex: 1 !important; max-width: calc(100% - 300px) !important; }
            .print-footer .print-row { flex-direction: row !important; justify-content: space-between !important; align-items: center !important; }
            .print-footer-right { width: 280px !important; padding-left: 1.5rem !important; }
            .bank-table { max-width: 320px !important; }
            /* í˜ì´ì§€ ë‚˜ëˆ” ë°©ì§€ */
            .print-footer, .seal-wrapper, .catchphrase-container { page-break-inside: avoid !important; }
            .max-w-4xl > div:last-child { page-break-inside: avoid !important; }
            .premium-table, .bank-table { page-break-inside: avoid !important; }
            .print-keep { page-break-inside: avoid !important; }
        }
    </style>
</head>
<body class="antialiased overflow-hidden">
    <script>
    (function(){
      function fmt(x){ return x.getFullYear()+'.'+String(x.getMonth()+1).padStart(2,'0')+'.'+String(x.getDate()).padStart(2,'0'); }
      function run(){
        var d=new Date(), d7=new Date(d); d7.setDate(d7.getDate()+7);
        var s=d.toISOString().split('T')[0], s7=d7.toISOString().split('T')[0];
        var iq=document.getElementById('in-quote-date'), ie=document.getElementById('in-expiry-date');
        var pt=document.getElementById('pv-today'), pe=document.getElementById('pv-expiry-val');
        if(iq){ iq.value=s; }
        if(ie){ ie.value=s7; }
        if(pt){ pt.innerText=fmt(d); }
        if(pe){ pe.innerText=fmt(d7); }
      }
      if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',run);
      else run();
    })();
    </script>
    <div class="flex flex-col md:flex-row h-screen overflow-y-auto md:overflow-hidden">
        <aside class="admin-sidebar flex-shrink-0 flex flex-col overflow-y-auto shadow-xl z-20 no-print md:w-[500px]">
            <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center flex-shrink-0">
                <h2 class="font-bold text-slate-800 text-sm flex items-center gap-2"><i class="fa-solid fa-file-invoice-dollar text-blue-600"></i> ê²¬ì  ë§ˆìŠ¤í„° v4.0</h2>
                <div class="flex gap-1.5">
                    <button onclick="loadSample()" class="text-[9px] font-bold border border-slate-200 px-2 py-0.5 rounded bg-white hover:bg-slate-50">ìƒ˜í”Œ</button>
                    <button onclick="resetAll()" class="text-[9px] font-bold border border-slate-200 px-2 py-0.5 rounded bg-white text-red-500 hover:bg-red-50">ì´ˆê¸°í™”</button>
                    <button onclick="testGoogleSheet()" class="text-[9px] font-bold border border-green-300 px-2 py-0.5 rounded bg-green-50 text-green-700 hover:bg-green-100" title="í˜„ì¬ ì…ë ¥ê°’ì„ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì „ì†¡ í…ŒìŠ¤íŠ¸">ì‹œíŠ¸í…ŒìŠ¤íŠ¸</button>
                </div>
            </div>
            <div class="p-4 space-y-4 overflow-y-auto flex-1 min-h-0">
                <!-- 0. í…œí”Œë¦¿ -->
                <section class="space-y-2">
                    <div class="section-title flex items-center justify-between">
                        <span><i class="fa-solid fa-bookmark mr-1"></i> í…œí”Œë¦¿</span>
                    </div>
                    <div class="flex gap-2">
                        <select id="template-select" class="admin-input flex-1 text-[11px]" onchange="loadTemplate(this.value)">
                            <option value="">â€” í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° â€”</option>
                        </select>
                        <button onclick="saveTemplate()" class="text-[10px] font-bold bg-slate-600 text-white px-3 py-1.5 rounded hover:bg-slate-700 whitespace-nowrap">ì €ì¥</button>
                        <button onclick="deleteTemplate()" class="text-[10px] font-bold border border-slate-300 px-2 py-1.5 rounded hover:bg-slate-100 text-slate-500" title="ì„ íƒí•œ í…œí”Œë¦¿ ì‚­ì œ">ì‚­ì œ</button>
                    </div>
                </section>

                <!-- 1. ìˆ˜ì‹ ì •ë³´ -->
                <section class="space-y-2">
    <div class="section-title">1. ìˆ˜ì‹ ì •ë³´</div>
    <div class="grid grid-cols-3 gap-2">
        <div class="col-span-2">
            <label class="field-label">ìˆ˜ì‹ ì</label>
            <div class="flex gap-1">
                <div class="relative flex-1">
                    <input type="text" id="in-customer" class="admin-input w-full" value="ê¹€ì§„ì™• ì›ì¥" oninput="onCustomerInput(this.value)" autocomplete="off" placeholder="ê³ ê°ëª… ê²€ìƒ‰...">
                    <div id="customer-dropdown" class="absolute left-0 right-0 top-full mt-0.5 bg-white border border-slate-200 rounded shadow-lg z-50 hidden max-h-40 overflow-y-auto text-[11px]"></div>
                </div>
                <button type="button" onclick="handleCustomerMatch()" class="bg-blue-600 text-white px-3 py-1 rounded text-[10px] font-bold hover:bg-blue-700 transition-colors whitespace-nowrap">ê³ ê°ì¡°íšŒ</button>
            </div>
        </div>
        <div>
            <label class="field-label">ì—°ë½ì²˜</label>
            <input type="text" id="in-phone" class="admin-input" value="010-1234-5678" oninput="updatePreview()">
        </div>
        <div class="col-span-3">
            <label class="field-label">ì´ë©”ì¼</label>
            <input type="text" id="in-email" class="admin-input" value="jinwang.kim@teheran-sample.com" oninput="updatePreview()">
        </div>
    </div>
</section>

                <!-- 2. ë°œì‹ ì •ë³´ -->
                <section class="space-y-2">
                    <div class="section-title">2. ë°œì‹ ì •ë³´</div>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="field-label">ë‹´ë‹¹ ë³€ë¦¬ì‚¬</label><input type="text" id="in-sender-name" class="admin-input" value="ìœ¤ì›…ì±„" oninput="updatePreview()"></div>
                        <div><label class="field-label">ì—°ë½ì²˜</label><input type="text" id="in-sender-phone" class="admin-input" value="010-8875-4370" oninput="updatePreview()"></div>
                        <div><label class="field-label">ì´ë©”ì¼</label><input type="text" id="in-sender-email" class="admin-input" value="wcyoon@thrlaw.co.kr" oninput="updatePreview()"></div>
                    </div>
                </section>

                <!-- 3. ê²¬ì ìƒì„±ì¼/ìœ íš¨ê¸°ê°„ -->
                <section class="space-y-2">
                    <div class="section-title">3. ê²¬ì ìƒì„±ì¼ / ìœ íš¨ê¸°ê°„</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="field-label">ê²¬ì  ìƒì„±ì¼</label><input type="date" id="in-quote-date" class="admin-input" oninput="updatePreview()"></div>
                        <div>
                            <label class="field-label">ìœ íš¨ê¸°ê°„</label>
                            <select id="in-expiry-opt" class="admin-input" onchange="handleExpiry(this.value)">
                                <option value="3">3ì¼ê°„</option><option value="7" selected>7ì¼ê°„</option><option value="15">15ì¼ê°„</option><option value="custom">ì§ì ‘ ì„ íƒ</option>
                            </select>
                            <input type="date" id="in-expiry-date" class="admin-input mt-1 hidden" oninput="updatePreview()">
                        </div>
                    </div>
                </section>

                <!-- 4. ê²¬ì ì„¸ë¶€ì •ë³´ -->
                <section class="space-y-2">
                    <div class="section-title">4. ê²¬ì ì„¸ë¶€ì •ë³´ (Doc Info)</div>
                    <!-- [ADD] detail builder ì„ íƒ UI -->
                    <div id="detail-builder" class="p-2 bg-slate-50 border border-slate-200 rounded text-[10px] space-y-2">
                        <div class="flex flex-wrap gap-x-3 gap-y-1"><span class="text-slate-500 font-bold">ê²¬ì ì„œ/ì²­êµ¬ì„œ:</span><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-doc" id="cb-estimate" onchange="handleSingleSelect(this); syncDetailBuilder()">ê²¬ì ì„œ</label><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-doc" id="cb-invoice" onchange="handleSingleSelect(this); syncDetailBuilder()">ì²­êµ¬ì„œ</label></div>
                        <div class="flex flex-wrap gap-x-3 gap-y-1"><span class="text-slate-500 font-bold">ì‹ ê·œ/ê¸°ì¡´:</span><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-newold" id="cb-new" onchange="handleSingleSelect(this); syncDetailBuilder()">ì‹ ê·œ</label><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-newold" id="cb-existing" onchange="handleSingleSelect(this); syncDetailBuilder()">ê¸°ì¡´</label></div>
                        <div class="flex flex-wrap gap-x-2 gap-y-1 items-center"><span class="text-slate-500 font-bold">IPìœ í˜•:</span><label class="inline-flex items-center gap-1"><input type="checkbox" id="cb-patent" onchange="syncDetailBuilder()">íŠ¹í—ˆ</label><label class="inline-flex items-center gap-1"><input type="checkbox" id="cb-utility" onchange="syncDetailBuilder()">ì‹¤ìš©ì‹ ì•ˆ</label><label class="inline-flex items-center gap-1"><input type="checkbox" id="cb-trademark" onchange="syncDetailBuilder()">ìƒí‘œ</label><label class="inline-flex items-center gap-1"><input type="checkbox" id="cb-design" onchange="syncDetailBuilder()">ë””ìì¸</label><label class="inline-flex items-center gap-1"><input type="checkbox" id="cb-ip-custom" onchange="syncDetailBuilder()">ì§ì ‘ì…ë ¥</label><input type="text" id="in-ip-custom" class="admin-input w-16 text-[9px] h-6 hidden" placeholder="ì…ë ¥" oninput="syncDetailBuilder()"></div>
                        <div class="flex flex-wrap gap-x-2 gap-y-1 items-center"><span class="text-slate-500 font-bold">ë‹¨ê³„:</span><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-stage" id="cb-apply" onchange="handleSingleSelect(this); syncDetailBuilder()">ì¶œì›</label><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-stage" id="cb-register" onchange="handleSingleSelect(this); syncDetailBuilder()">ë“±ë¡</label><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-stage" id="cb-mid" onchange="handleSingleSelect(this); syncDetailBuilder()">ì¤‘ê°„ì‚¬ê±´</label><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-stage" id="cb-stage-custom" onchange="handleSingleSelect(this); syncDetailBuilder()">ì§ì ‘ì…ë ¥</label><input type="text" id="in-stage-custom" class="admin-input w-16 text-[9px] h-6 hidden" placeholder="ì…ë ¥" oninput="syncDetailBuilder()"></div>
                        <div class="flex flex-wrap gap-x-2 gap-y-1"><span class="text-slate-500 font-bold">ì‹¬ì‚¬:</span><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-exam" id="cb-normal" onchange="handleSingleSelect(this); syncDetailBuilder()">ì¼ë°˜ì‹¬ì‚¬</label><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-exam" id="cb-priority" onchange="handleSingleSelect(this); syncDetailBuilder()">ìš°ì„ ì‹¬ì‚¬</label><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-exam" id="cb-exam-na" onchange="handleSingleSelect(this); syncDetailBuilder()">í•´ë‹¹ì—†ìŒ</label></div>
                        <div class="flex flex-wrap gap-x-2 gap-y-1 items-center"><span class="text-slate-500 font-bold">ê±´ìˆ˜:</span><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-count" id="cb-count1" onchange="handleSingleSelect(this); syncDetailBuilder()">1ê±´</label><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-count" id="cb-count2" onchange="handleSingleSelect(this); syncDetailBuilder()">2ê±´</label><label class="inline-flex items-center gap-1"><input type="checkbox" name="cb-count" id="cb-count-custom" onchange="handleSingleSelect(this); syncDetailBuilder()">ì§ì ‘ì…ë ¥</label><input type="text" id="in-count-custom" class="admin-input w-12 text-[9px] h-6 hidden" placeholder="ê±´" oninput="syncDetailBuilder()"></div>
                    </div>
                    <input type="text" id="in-quote-info" class="admin-input" value="ì‹ ê·œ, íŠ¹í—ˆì¶œì›, ìš°ì„ ì‹¬ì‚¬, 1ê±´" oninput="updatePreview(); syncDetailBuilderFromInput();" placeholder="ì„ì˜ ê¸°ì¬">
                </section>

                <!-- 5. ì œì•ˆì„œ ì œëª© -->
                <section class="space-y-2">
                    <div class="section-title flex items-center justify-between"><span>5. ì œì•ˆì„œ ì œëª©</span><button type="button" onclick="updateAutoTitle(); updatePreview();" class="text-[9px] text-slate-500 hover:text-blue-600" title="ì„ íƒê°’ìœ¼ë¡œ ì œëª© ë‹¤ì‹œ ìƒì„±">ğŸ”„ ë‹¤ì‹œìƒì„±</button></div>
                    <input type="text" id="in-title" class="admin-input" value="íŠ¹í—ˆì¶œì› ë¹„ìš© ê²¬ì ì„œ ì†¡ë¶€ì˜ ê±´" oninput="updatePreview()" placeholder="ì„ì˜ ê¸°ì¬">
                </section>

                <!-- 6. ë¹„ìš©ì„¸ë¶€í•­ëª© -->
                <section class="space-y-2">
                    <div class="section-title flex items-center justify-between">
                        <span>6. ë¹„ìš©ì„¸ë¶€í•­ëª©</span>
                        <button onclick="addRow()" class="text-[9px] bg-blue-600 text-white px-2 py-0.5 rounded font-bold hover:bg-blue-700">+ ì¶”ê°€</button>
                    </div>
                    <div id="items-container" class="space-y-3"></div>
                </section>

                <!-- 7. ì€í–‰ì •ë³´ / ì´ë¯¸ì§€ / í•˜ë‹¨ë©˜íŠ¸ / ì´ê¸ˆì•¡ ë¬¸êµ¬ -->
                <section class="space-y-2">
                    <div class="section-title">7. ì€í–‰ì •ë³´</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="field-label">ì€í–‰ëª…</label><input type="text" id="in-bank-name" class="admin-input" oninput="updatePreview()" value="ì‹ í•œì€í–‰"></div>
                        <div><label class="field-label">ê³„ì¢Œë²ˆí˜¸</label><input type="text" id="in-bank-account" class="admin-input" oninput="updatePreview()" value="140-012-565030"></div>
                        <div><label class="field-label">ì˜ˆê¸ˆì£¼</label><input type="text" id="in-bank-owner" class="admin-input" oninput="updatePreview()" value="íŠ¹í—ˆë²•ì¸ í…Œí—¤ë€"></div>
                        <div><label class="field-label">ë‹´ë‹¹ì§ì›</label><input type="text" id="in-manager" class="admin-input" oninput="updatePreview()" value="ê´€ë¦¬íŒ€ ë°•ì†”ì•„ì°¨ì¥"></div>
                    </div>
                </section>

                <section class="space-y-2">
                    <div class="section-title">ì´ë¯¸ì§€ ì„¤ì • (ë¡œê³ /ë„ì¥)</div>
                    <div class="flex gap-2">
                        <label class="cursor-pointer bg-slate-700 text-white px-3 py-1.5 rounded text-[10px] font-bold hover:bg-slate-600 flex items-center gap-1.5 flex-1 justify-center relative overflow-hidden">
                            <input type="file" id="logo-upload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleImageUpload(this,'pv-logo','teheran_logo_v1')">
                            <i class="fa-solid fa-image relative z-10"></i> <span class="relative z-10">ë¡œê³ </span>
                        </label>
                        <label class="cursor-pointer bg-white border border-slate-300 text-slate-700 px-3 py-1.5 rounded text-[10px] font-bold hover:bg-slate-50 flex items-center gap-1.5 flex-1 justify-center relative overflow-hidden">
                            <input type="file" id="seal-upload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleImageUpload(this,'pv-seal-img','teheran_seal_v1')">
                            <i class="fa-solid fa-stamp text-red-500 relative z-10"></i> <span class="relative z-10">ë„ì¥</span>
                        </label>
                    </div>
                    <label class="flex items-center gap-2 text-[10px] text-slate-500 cursor-pointer">
                        <input type="checkbox" id="logo-filter-check" class="w-4 h-4" onchange="toggleLogoFilter(this.checked)" checked> ë¡œê³  ë°°ê²½ íˆ¬ëª…í™”
                    </label>
                    <p class="text-[9px] text-slate-400">* logo.png, seal.png íŒŒì¼ì´ ìˆìœ¼ë©´ ê¸°ë³¸ í‘œì‹œ</p>
                </section>

                <section class="space-y-2">
                    <div class="section-title flex items-center justify-between">
                        <span>í•˜ë‹¨ ì•ˆë‚´ ë©˜íŠ¸</span>
                        <button onclick="addNotice()" class="text-[9px] border border-slate-300 px-2 py-0.5 rounded">+ ì¤„</button>
                    </div>
                    <div id="notice-container" class="space-y-1.5"></div>
                    <div>
                        <label class="field-label">ì´ê¸ˆì•¡ í•˜ë‹¨ ë¬¸êµ¬</label>
                        <input type="text" id="in-total-note" class="admin-input" value="ê´€ë‚©ë£Œ, ìˆ˜ìˆ˜ë£Œ, ë¶€ê°€ê°€ì¹˜ì„¸(10%) í¬í•¨" oninput="updatePreview()">
                    </div>
                </section>

                <div class="p-4 bg-slate-900 rounded-lg text-white flex-shrink-0">
                    <div class="flex justify-between text-[11px] mb-2 opacity-60"><span>ìµœì¢… í•©ê³„ (VAT í¬í•¨)</span><span id="admin-total-preview">â‚© 0</span></div>
                    <button id="btn-publish" onclick="publishQuote()" class="w-full bg-blue-600 py-3 rounded font-bold text-sm hover:bg-blue-500 transition shadow-lg">ê²¬ì ì„œ ë°œí–‰ ë° ë§í¬ ë³µì‚¬</button>
                </div>
            </div>
        </aside>

        <!-- ëª¨ë°”ì¼ì—ì„œë§Œ í‘œì‹œ: ì…ë ¥ í¼ê³¼ ë¯¸ë¦¬ë³´ê¸° êµ¬ë¶„ -->
        <div id="mobile-preview-divider" class="md:hidden flex-shrink-0 py-4 px-4 bg-slate-200 text-center no-print">
            <span class="text-sm font-bold text-slate-600">â–¼ ê²¬ì ì„œ ë¯¸ë¦¬ë³´ê¸°</span>
        </div>

        <main id="preview-container" class="flex-shrink-0 md:flex-grow overflow-y-auto">
            <div class="max-w-4xl mx-auto shadow-2xl bg-white min-h-[900px] border border-slate-200 flex flex-col">
                <div class="hero-header text-center">
                    <div class="logo-center">
                        <img id="pv-logo" src="" class="logo-img" alt="TEHERAN" style="display:none;">
                        <span id="pv-logo-text">TEHERAN</span>
                    </div>
                    <h1 id="pv-title" class="text-xl md:text-2xl font-bold tracking-tight mb-4 md:mb-6 px-4 md:px-12 text-white">íŠ¹í—ˆì¶œì› ë¹„ìš© ê²¬ì ì„œ ì†¡ë¶€ì˜ ê±´</h1>
                    
                    <div class="print-row px-4 md:px-12 pb-4 md:pb-6 flex flex-col md:flex-row md:justify-between md:items-end gap-3 text-white">
                        <div class="print-half text-left w-full md:w-1/2">
                            <div class="space-y-1 text-[12px] opacity-90 font-light">
                                <p><span class="label-left">ìˆ˜ì‹ ì</span> : <span id="pv-customer" class="text-white">ê¹€ì§„ì™• ì›ì¥</span></p>
                                <p><span class="label-left">ì—°ë½ì²˜</span> : <span id="pv-phone">010-1234-5678</span></p>
                                <p><span class="label-left">ì´ë©”ì¼</span> : <span id="pv-email">jinwang.kim@teheran-sample.com</span></p>
                            </div>
                        </div>
                        
                        <div class="print-half w-full md:w-1/2 flex flex-col md:items-end">
                            <div class="text-left">
                                <div class="space-y-1 text-[12px] opacity-90 font-light">
                                    <p><span class="label-right">ë‹´ë‹¹ë³€ë¦¬ì‚¬</span> : <span id="pv-sender-name" class="text-white">ìœ¤ì›…ì±„</span></p>
                                    <p><span class="label-right">ì—°ë½ì²˜</span> : <span id="pv-sender-phone">010-8875-4370</span></p>
                                    <p><span class="label-right">ì´ë©”ì¼</span> : <span id="pv-sender-email">wcyoon@thrlaw.co.kr</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="print-grid max-w-4xl mx-auto grid grid-cols-1 sm:grid-cols-3 border-t border-white/10 pt-3 md:pt-4 pb-3 md:pb-4 text-left text-[12px] md:text-[11px] text-white gap-4 sm:gap-0">
                        <div class="px-4 md:px-8 sm:border-r border-white/10"><p class="opacity-50 mb-1 uppercase text-[10px] md:text-[9px]">ê²¬ì ì¼</p><p id="pv-today">-</p></div>
                        <div class="px-4 md:px-8 sm:border-r border-white/10"><p class="opacity-50 mb-1 uppercase text-[10px] md:text-[9px]">ê²¬ì  ìœ íš¨ê¸°ê°„</p><p id="pv-expiry-val" class="text-blue-300">-</p></div>
                        <div class="px-4 md:px-8"><p class="opacity-50 text-[10px] md:text-[8px] mb-1 uppercase">ê²¬ì  ì •ë³´</p><p id="pv-quote-info" class="opacity-90 font-medium">ì‹ ê·œ, íŠ¹í—ˆì¶œì›, ìš°ì„ ì‹¬ì‚¬, 1ê±´</p></div>
                    </div>
                </div>

                <div class="p-4 md:p-8 flex-grow relative flex flex-col">
                    <div class="overflow-x-auto -mx-4 md:mx-0 mb-4 md:mb-6">
                    <table class="w-full text-left premium-table min-w-[320px]">
                        <thead>
                            <tr>
                                <th>ì„œë¹„ìŠ¤ ìƒì„¸ í•­ëª©</th>
                                <th class="col-gov">íŠ¹í—ˆì²­ ê´€ë‚©ë£Œ</th>
                                <th class="col-fee">ëŒ€ë¦¬ì¸ ìˆ˜ìˆ˜ë£Œ</th>
                            </tr>
                        </thead>
                        <tbody id="pv-table-body" class="divide-y divide-slate-50">
                            <tr>
                                <td><div class="font-bold text-slate-800 text-[14px]">íŠ¹í—ˆì¶œì› (ë°”ì´ì˜¤ëª¨ë“ˆë ˆì´í„°)</div><div class="text-[10px] text-slate-400 mt-0.5">íŠ¹í—ˆì²­ ì‹¤ë¹„ í¬í•¨</div></td>
                                <td class="col-gov"><div class="text-slate-500 font-medium">46,000</div><div class="text-[9px] text-slate-400 font-medium mt-0.5">*ì²­êµ¬í•­ 5í•­ ê¸°ì¤€</div></td>
                                <td class="col-fee"><div class="text-slate-900 font-bold">1,500,000</div><div class="text-[9px] text-slate-400 font-medium mt-0.5">*ë¶€ê°€ì„¸ë³„ë„</div></td>
                            </tr>
                        </tbody>
                    </table>
                    </div>

                    <div class="print-keep print-row print-row-center flex flex-col md:flex-row gap-0 bg-[#F8FAFC] p-4 md:p-6 mt-4 md:mt-8 border-t border-slate-200">
                        <div class="flex-grow flex flex-col justify-center md:pr-8 order-last md:order-none pt-4 md:pt-0">
                            <div id="pv-notice" class="space-y-1 text-[11px] md:text-[10px] text-slate-400 leading-relaxed font-light"><div>â€¢ ë³¸ ê²¬ì  ê¸ˆì•¡ì—ëŠ” ëŒ€ë¦¬ì¸ ìˆ˜ìˆ˜ë£Œì— ëŒ€í•œ ë¶€ê°€ê°€ì¹˜ì„¸(10%)ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</div><div>â€¢ ê´€ë‚©ë£ŒëŠ” êµ­ê°€ ì‹¤ë¹„ë¡œì„œ, ê³ ê°ì‚¬ì˜ ê°ë©´ ì¡°ê±´ì— ë”°ë¼ ì‹¤ì œ ë‚©ë¶€ ì‹œì ì— ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div><div>â€¢ ì°©ìˆ˜ê¸ˆ ì…ê¸ˆ í™•ì¸ í›„ ì—…ë¬´ê°€ ê³µì‹ì ìœ¼ë¡œ ê°œì‹œë©ë‹ˆë‹¤.</div></div>
                        </div>
                        <div id="total-divider" class="print-total w-full md:w-[300px] text-right flex flex-col justify-center border-b md:border-b-0 md:border-l border-slate-200 pb-4 md:pb-0 md:pt-0 md:pl-8 order-first md:order-none">
                            <p class="text-[10px] text-slate-400 font-bold tracking-widest uppercase mb-1">ì´ê¸ˆì•¡</p>
                            <h2 id="pv-total" class="text-3xl font-extrabold tracking-tighter text-[#001A35]">â‚© 1,696,000</h2>
                            <p id="pv-total-note" class="text-[10px] text-slate-400 mt-2 leading-relaxed italic">ê´€ë‚©ë£Œ, ìˆ˜ìˆ˜ë£Œ, ë¶€ê°€ê°€ì¹˜ì„¸(10%) í¬í•¨</p>
                        </div>
                    </div>

                    <div class="print-row print-bank mt-4 md:mt-6 mb-2 flex flex-col md:flex-row md:justify-between md:items-end gap-4">
                        <div class="print-bank-left w-full md:w-[calc(100%-300px)]">
                            <table class="bank-table">
                                <tr><td>ì€í–‰ëª…</td><td id="pv-bank-name">ì‹ í•œì€í–‰</td></tr>
                                <tr><td>ê³„ì¢Œë²ˆí˜¸</td><td id="pv-bank-account" class="font-bold text-slate-800">140-012-565030</td></tr>
                                <tr><td>ì˜ˆê¸ˆì£¼</td><td id="pv-bank-owner">íŠ¹í—ˆë²•ì¸ í…Œí—¤ë€</td></tr>
                                <tr><td>ë‹´ë‹¹ì§ì›</td><td id="pv-manager" class="text-blue-600 font-bold">ê´€ë¦¬íŒ€ ë°•ì†”ì•„ì°¨ì¥</td></tr>
                            </table>
                        </div>
                        <div class="no-print w-full md:flex-grow flex justify-end pb-1">
                            <button type="button" id="btn-print" class="text-[11px] md:text-[10px] font-bold text-slate-400 border border-slate-200 px-5 py-2.5 rounded hover:bg-slate-50 flex items-center gap-1.5 w-full md:w-auto justify-center">
                                <i class="fa-solid fa-print"></i> PDF ì €ì¥ / ì¸ì‡„í•˜ê¸°
                            </button>
                        </div>
                    </div>

                    <footer class="print-footer border-t border-slate-200 pt-6 md:pt-8 mt-auto text-[11px] md:text-[10px] text-slate-500">
                        <div class="print-row flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-2 md:mb-3 mt-3 md:mt-4">
                            <div class="catchphrase-container">
                                <div class="cp-text">ê¸¸ëˆˆì´ ë°ì€,</div>
                                <div class="cp-text text-blue-600">ì‚¬ì—…íŒŒíŠ¸ë„ˆ í…Œí—¤ë€</div>
                            </div>
                            
                            <div class="print-footer-right text-left space-y-1 w-full md:w-[300px] md:pl-10">
                                <div class="seal-wrapper">
                                    <p class="text-[13px] font-bold text-slate-800 mb-1">íŠ¹í—ˆë²•ì¸ í…Œí—¤ë€</p>
                                    <img id="pv-seal-img" src="" class="official-seal" alt="ì¸ê°ë„ì¥">
                                </div>
                                <p>ì„œìš¸ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 418, ë‹¤ë´‰íƒ€ì›Œ 5ì¸µ (ëŒ€ì¹˜ë™)</p>
                                <p>Tel: 02-2038-7679 | Fax: 02-2038-0879</p>
                                <p>Email: patent@thrlaw.co.kr</p>
                                <p>H.P: <a href="http://www.teheranpat.com" target="_blank" class="text-blue-600 font-medium hover:underline">www.teheranpat.com</a></p>
                            </div>
                        </div>
                    </footer>
                </div>
            </div>
        </main>

        <!-- ëª¨ë°”ì¼ ì „ìš©: í•˜ë‹¨ ê³ ì • PDF/ì¸ì‡„ ë²„íŠ¼ (í„°ì¹˜ ì˜ì—­ í™•ëŒ€) -->
        <div class="print-btn-fixed md:hidden no-print">
            <button type="button" id="btn-print-mobile" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-bold text-sm flex items-center justify-center gap-2 shadow-lg active:bg-blue-700">
                <i class="fa-solid fa-print"></i> PDF ì €ì¥ / ì¸ì‡„í•˜ê¸°
            </button>
        </div>
    </div>

<script>
        // 1. ê¸°ë³¸ ì„¤ì •ê°’ (ë³€ë¦¬ì‚¬ë‹˜ì˜ ê¸°ì¡´ ì„¤ì • ìœ ì§€ + í”„ë¡œì íŠ¸ URL ì—…ë°ì´íŠ¸)
        const SUPABASE_URL  = 'https://pduhmdgsgtihrbwzrcjo.supabase.co';         // ìƒˆ Supabase í”„ë¡œì íŠ¸ URL
        const SUPABASE_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkdWhtZGdzZ3RpaHJid3pyY2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDM1ODAsImV4cCI6MjA4NzU3OTU4MH0.86pwEjfm4qmTZulCBYabRpm-Z6fKgL44p1Y9fo9jjwo';   // Supabase anon public key
        const STORAGE_BUCKET = 'quote-assets';
        const GOOGLE_SHEETS_WEBHOOK = 'YOUR_GOOGLE_SHEETS_WEBHOOK_URL_HERE'; // Apps Script ë°°í¬ URL
        
        let _supabase = null;

        // 2. Supabase ì´ˆê¸°í™” ë¡œì§ (ê¸°ì¡´ êµ¬ì¡° ìœ ì§€)
        function whenSupabaseReady() {
            if (typeof supabase !== 'undefined') { 
                try { 
                    _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); 
                    checkUrlAndLoad(); // ê¸°ì¡´ ì €ì¥ëœ ë°ì´í„° ë¡œë“œ ê¸°ëŠ¥ ìœ ì§€
                } catch(e) { console.error('Supabase init error:', e); } 
                return; 
            }
            var t = setInterval(function() { 
                if (typeof supabase !== 'undefined') { 
                    clearInterval(t); 
                    try { 
                        _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); 
                        checkUrlAndLoad(); 
                    } catch(e) {} 
                } 
            }, 100);
            setTimeout(function() { clearInterval(t); }, 8000);
        }

        // 3. ê³ ê° ìë™ì™„ì„± + ì¡°íšŒ (clients í…Œì´ë¸”)
        let currentClientId = null;       // ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒëœ clients.id
        let _dropdownClients = [];
        let _clientSearchTimer = null;

        function _escHtml(s) {
            if (!s) return '';
            return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        // ì…ë ¥í•  ë•Œë§ˆë‹¤ clients í…Œì´ë¸” ì‹¤ì‹œê°„ ê²€ìƒ‰
        async function onCustomerInput(val) {
            updatePreview();
            currentClientId = null;
            clearTimeout(_clientSearchTimer);
            const dd = document.getElementById('customer-dropdown');
            if (!val || val.length < 1) { dd.classList.add('hidden'); return; }

            _clientSearchTimer = setTimeout(async function() {
                if (!_supabase) { dd.classList.add('hidden'); return; }
                try {
                    const { data } = await _supabase
                        .from('clients')
                        .select('id, name, phone, email, client_type')
                        .ilike('name', '%' + val + '%')
                        .eq('is_active', true)
                        .limit(8);
                    if (!data || data.length === 0) { dd.classList.add('hidden'); return; }
                    _dropdownClients = data;
                    dd.innerHTML = data.map(function(c, i) {
                        return '<div class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-slate-100 last:border-0"'
                            + ' onclick="_pickClient(' + i + ')">'
                            + '<div class="font-bold text-slate-800">' + _escHtml(c.name) + '</div>'
                            + '<div class="text-slate-400 text-[9px]">' + _escHtml(c.client_type || '') + ' ' + _escHtml(c.phone || '') + '</div>'
                            + '</div>';
                    }).join('');
                    dd.classList.remove('hidden');
                } catch(e) { dd.classList.add('hidden'); }
            }, 280);
        }

        function _pickClient(idx) {
            const c = _dropdownClients[idx];
            if (!c) return;
            currentClientId = c.id;
            document.getElementById('in-customer').value = c.name;
            if (c.phone) document.getElementById('in-phone').value = c.phone;
            if (c.email) document.getElementById('in-email').value = c.email;
            document.getElementById('customer-dropdown').classList.add('hidden');
            updatePreview();
        }

        // ê³ ê°ì¡°íšŒ ë²„íŠ¼ í´ë¦­ â†’ DBì—ì„œ ê²€ìƒ‰í•´ì„œ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
        async function handleCustomerMatch() {
            if (!_supabase) { alert("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); return; }
            const name = document.getElementById('in-customer').value.trim();
            if (!name) { alert("ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            try {
                const { data } = await _supabase
                    .from('clients')
                    .select('id, name, phone, email, client_type')
                    .ilike('name', '%' + name + '%')
                    .eq('is_active', true)
                    .limit(8);
                if (!data || data.length === 0) {
                    alert('"' + name + '" ê³ ê°ì´ DBì— ì—†ìŠµë‹ˆë‹¤. ë°œí–‰ ì‹œ ìë™ ë“±ë¡ë©ë‹ˆë‹¤.');
                    return;
                }
                if (data.length === 1) {
                    _dropdownClients = data;
                    _pickClient(0);
                    alert('[ê³ ê° í™•ì¸] ' + data[0].name + 'ë‹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                    return;
                }
                // ë³µìˆ˜ ê²°ê³¼ â†’ ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ í‘œì‹œ
                _dropdownClients = data;
                const dd = document.getElementById('customer-dropdown');
                dd.innerHTML = data.map(function(c, i) {
                    return '<div class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-slate-100 last:border-0"'
                        + ' onclick="_pickClient(' + i + ')">'
                        + '<div class="font-bold text-slate-800">' + _escHtml(c.name) + '</div>'
                        + '<div class="text-slate-400 text-[9px]">' + _escHtml(c.client_type || '') + ' ' + _escHtml(c.phone || '') + '</div>'
                        + '</div>';
                }).join('');
                dd.classList.remove('hidden');
            } catch(err) {
                console.error(err);
                alert("ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
        
        // ë“œë¡­ë‹¤ìš´ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', function(ev) {
            const dd  = document.getElementById('customer-dropdown');
            const inp = document.getElementById('in-customer');
            if (dd && !dd.contains(ev.target) && ev.target !== inp) {
                dd.classList.add('hidden');
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', whenSupabaseReady);

        function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = (arr[0].match(/:(.*?);/) || [])[1] || 'image/png';
            const bstr = atob(arr[1]);
            const u8arr = new Uint8Array(bstr.length);
            for (let i = 0; i < bstr.length; i++) u8arr[i] = bstr.charCodeAt(i);
            return new Blob([u8arr], { type: mime });
        }

        function compressImage(dataURL, maxW) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    let w = img.width, h = img.height;
                    if (w > maxW) { h = (h * maxW) / w; w = maxW; }
                    const c = document.createElement('canvas');
                    c.width = w; c.height = h;
                    const ctx = c.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(c.toDataURL('image/png', 0.85));
                };
                img.onerror = () => resolve(dataURL);
                img.src = dataURL;
            });
        }

        async function uploadImageToStorage(dataURL, fileName) {
            try {
                const blob = dataURLtoBlob(dataURL);
                const ext = blob.type === 'image/png' ? 'png' : blob.type === 'image/jpeg' ? 'jpg' : 'png';
                const path = `quotes/${Date.now()}_${Math.random().toString(36).slice(2)}_${fileName}.${ext}`;
                const { data: uploadData, error } = await _supabase.storage.from(STORAGE_BUCKET).upload(path, blob, { contentType: blob.type, upsert: true });
                if (error) {
                    console.error('Storage error:', error);
                    return { error: error.message || JSON.stringify(error) };
                }
                const { data: { publicUrl } } = _supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
                return publicUrl;
            } catch (e) {
                console.error('Storage upload failed:', e);
                return { error: e.message || String(e) };
            }
        }
        let items = [{ id: 1, name: 'íŠ¹í—ˆì¶œì› (ë°”ì´ì˜¤ëª¨ë“ˆë ˆì´í„°)', govPrice: 46000, feePrice: 1500000, isGovTBD: false, note: 'íŠ¹í—ˆì²­ ì‹¤ë¹„ í¬í•¨', govText: '*ì²­êµ¬í•­ 5í•­ ê¸°ì¤€', feeText: '*ë¶€ê°€ì„¸ë³„ë„' }];
        let notices = ["â€¢ ë³¸ ê²¬ì  ê¸ˆì•¡ì—ëŠ” ëŒ€ë¦¬ì¸ ìˆ˜ìˆ˜ë£Œì— ëŒ€í•œ ë¶€ê°€ê°€ì¹˜ì„¸(10%)ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.", "â€¢ ê´€ë‚©ë£ŒëŠ” êµ­ê°€ ì‹¤ë¹„ë¡œì„œ, ê³ ê°ì‚¬ì˜ ê°ë©´ ì¡°ê±´ì— ë”°ë¼ ì‹¤ì œ ë‚©ë¶€ ì‹œì ì— ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "â€¢ ì°©ìˆ˜ê¸ˆ ì…ê¸ˆ í™•ì¸ í›„ ì—…ë¬´ê°€ ê³µì‹ì ìœ¼ë¡œ ê°œì‹œë©ë‹ˆë‹¤."];
        
        function getFormattedDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}.${month}.${day}`;
        }

        function sanitizeFilename(s) {
            if (!s || typeof s !== 'string') return '';
            return s.replace(/[/\\:*?"<>|]/g, '').replace(/\s+/g, '_').trim() || 'ê²¬ì ì„œ';
        }
        function doPrint(e) {
            if (e) { e.preventDefault(); e.stopPropagation(); }
            window.print();
        }
        function setPrintTitle() {
            const customer = document.getElementById('in-customer')?.value || '';
            const title = document.getElementById('in-title')?.value || '';
            const fn = sanitizeFilename(customer) + '_í…Œí—¤ë€_' + sanitizeFilename(title);
            if (fn && fn !== '_í…Œí—¤ë€_') {
                _originalTitle = document.title;
                document.title = fn;
            }
        }
        function restorePrintTitle() {
            if (_originalTitle) { document.title = _originalTitle; _originalTitle = null; }
        }
        let _originalTitle = null;
        function init() { 
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('in-quote-date').value = todayStr;
            
            [document.getElementById('btn-print'), document.getElementById('btn-print-mobile')].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', function(){ setPrintTitle(); doPrint(); });
                    btn.addEventListener('touchend', function(ev){ ev.preventDefault(); setPrintTitle(); doPrint(ev); }, { passive: false });
                }
            });
            window.addEventListener('beforeprint', setPrintTitle);
            window.addEventListener('afterprint', restorePrintTitle);
            
            refreshTemplateSelect();
            handleExpiry("7"); 
            renderInputs(); 
            renderNotices(); 
            // [ADD] detail builder ì´ˆê¸° ì²´í¬ (ì‹ ê·œ, íŠ¹í—ˆ, ì¶œì›, ìš°ì„ ì‹¬ì‚¬, 1ê±´, ê²¬ì ì„œ)
            var cbNew = document.getElementById('cb-new'); if (cbNew) cbNew.checked = true;
            var cbPatent = document.getElementById('cb-patent'); if (cbPatent) cbPatent.checked = true;
            var cbApply = document.getElementById('cb-apply'); if (cbApply) cbApply.checked = true;
            var cbPriority = document.getElementById('cb-priority'); if (cbPriority) cbPriority.checked = true;
            var cbCount1 = document.getElementById('cb-count1'); if (cbCount1) cbCount1.checked = true;
            var cbEst = document.getElementById('cb-estimate'); if (cbEst) cbEst.checked = true;
            updatePreview(); 
            loadSavedImages();
            toggleLogoFilter(document.getElementById('logo-filter-check').checked);
            checkUrlAndLoad();
            updatePreview();
        }
        
        function handleImageUpload(input, targetId, storageKey) {
            if (!input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(targetId);
                if (!img) return;
                img.src = e.target.result;
                img.style.display = 'block';
                if (targetId === 'pv-logo') {
                    document.getElementById('pv-logo-text').style.display = 'none';
                    toggleLogoFilter(document.getElementById('logo-filter-check').checked);
                }
                localStorage.setItem(storageKey, e.target.result);
            };
            reader.readAsDataURL(input.files[0]);
        }

        // [í•µì‹¬ ê¸°ìˆ ] ë¡œê³ ì˜ í°ìƒ‰ ë°°ê²½ì„ íˆ¬ëª…í•˜ê²Œ ë§Œë“œëŠ” CSS ì¡°í•© ì ìš©
        function toggleLogoFilter(isChecked) {
            const logoImg = document.getElementById('pv-logo');
            if (!logoImg) return;
            if(isChecked) {
                // 1. ìƒ‰ìƒ ë°˜ì „ (ê²€ì€ ê¸€ì”¨ -> í° ê¸€ì”¨, í° ë°°ê²½ -> ê²€ì€ ë°°ê²½)
                // 2. mix-blend-mode: screen (ê²€ì€ìƒ‰ ë°°ê²½ì„ íˆ¬ëª…í•˜ê²Œ ë§Œë“¦)
                logoImg.style.filter = 'invert(1)';
                logoImg.style.mixBlendMode = 'screen';
            } else {
                logoImg.style.filter = 'none';
                logoImg.style.mixBlendMode = 'normal';
            }
        }

        function loadSavedImages() {
            const logoImg = document.getElementById('pv-logo');
            const sealImg = document.getElementById('pv-seal-img');
            const savedLogo = localStorage.getItem('teheran_logo_v1');
            if (savedLogo) {
                logoImg.src = savedLogo;
                logoImg.style.display = 'block';
                document.getElementById('pv-logo-text').style.display = 'none';
            } else {
                logoImg.onload = function() { logoImg.style.display = 'block'; document.getElementById('pv-logo-text').style.display = 'none'; };
                logoImg.onerror = function() { logoImg.src = ''; };
                logoImg.src = 'logo.png';
            }
            const savedSeal = localStorage.getItem('teheran_seal_v1');
            if (savedSeal) {
                sealImg.src = savedSeal;
                sealImg.style.display = 'block';
            } else {
                sealImg.onload = function() { sealImg.style.display = 'block'; };
                sealImg.onerror = function() { sealImg.src = ''; };
                sealImg.src = 'seal.png';
            }
        }

        // [ADD] ë‹¨ì¼ì„ íƒ ê·¸ë£¹: í•œ í•­ëª© ì²´í¬ ì‹œ ê°™ì€ nameì˜ ë‚˜ë¨¸ì§€ í•´ì œ
        function handleSingleSelect(el) {
            if (!el || !el.checked || !el.name) return;
            document.querySelectorAll('input[name="' + el.name + '"]').forEach(function(cb) { if (cb !== el) cb.checked = false; });
        }
        // [ADD] detail builder - ê²¬ì ì„¸ë¶€ì •ë³´ ì„ íƒ â†’ ë¬¸ìì—´ ìƒì„±
        function syncDetailBuilder() {
            var newold = ''; var cbs = document.querySelectorAll('input[name="cb-newold"]:checked'); cbs.forEach(function(cb){ newold = cb.id === 'cb-new' ? 'ì‹ ê·œ' : 'ê¸°ì¡´'; });
            var ipArr = []; if (document.getElementById('cb-patent').checked) ipArr.push('íŠ¹í—ˆ'); if (document.getElementById('cb-utility').checked) ipArr.push('ì‹¤ìš©ì‹ ì•ˆ'); if (document.getElementById('cb-trademark').checked) ipArr.push('ìƒí‘œ'); if (document.getElementById('cb-design').checked) ipArr.push('ë””ìì¸'); if (document.getElementById('cb-ip-custom').checked) { var v = document.getElementById('in-ip-custom').value.trim(); if (v) ipArr.push(v); } var ipTypes = ipArr.join('/');
            var stage = ''; document.querySelectorAll('input[name="cb-stage"]:checked').forEach(function(cb){ var t = cb.id === 'cb-apply' ? 'ì¶œì›' : cb.id === 'cb-register' ? 'ë“±ë¡' : cb.id === 'cb-mid' ? 'ì¤‘ê°„ì‚¬ê±´' : (cb.id === 'cb-stage-custom' ? document.getElementById('in-stage-custom').value.trim() : ''); if (t) stage = t; });
            var exam = ''; document.querySelectorAll('input[name="cb-exam"]:checked').forEach(function(cb){ if (cb.id === 'cb-exam-na') exam = ''; else exam = cb.id === 'cb-normal' ? 'ì¼ë°˜ì‹¬ì‚¬' : 'ìš°ì„ ì‹¬ì‚¬'; });
            var cnt = ''; if (document.getElementById('cb-count1').checked) cnt = '1'; else if (document.getElementById('cb-count2').checked) cnt = '2'; else if (document.getElementById('cb-count-custom').checked) cnt = String(document.getElementById('in-count-custom').value.trim()).replace(/ê±´$/, '') || '1'; else cnt = '1';
            var docTypes = ''; document.querySelectorAll('input[name="cb-doc"]:checked').forEach(function(cb){ docTypes = cb.id === 'cb-estimate' ? 'ê²¬ì ì„œ' : 'ì²­êµ¬ì„œ'; });
            var parts = []; if (newold) parts.push(newold); if (ipTypes && stage) parts.push(ipTypes + ' ' + stage); else if (ipTypes) parts.push(ipTypes); else if (stage) parts.push(stage); if (exam) parts.push(exam); if (cnt) parts.push(cnt + 'ê±´'); if (docTypes) parts.push(docTypes);
            var s = parts.join(', ');
            if (parts.length) document.getElementById('in-quote-info').value = s;
            document.getElementById('in-ip-custom').classList.toggle('hidden', !document.getElementById('cb-ip-custom').checked);
            document.getElementById('in-stage-custom').classList.toggle('hidden', !document.getElementById('cb-stage-custom').checked);
            document.getElementById('in-count-custom').classList.toggle('hidden', !document.getElementById('cb-count-custom').checked);
            updateAutoTitle();
            updatePreview();
        }
        function syncDetailBuilderFromInput() { }
        // [ADD] auto title - ì œì•ˆì„œ ì œëª© ìë™ ìƒì„±
        function updateAutoTitle() {
            var ipArr = []; if (document.getElementById('cb-patent').checked) ipArr.push('íŠ¹í—ˆ'); if (document.getElementById('cb-utility').checked) ipArr.push('ì‹¤ìš©ì‹ ì•ˆ'); if (document.getElementById('cb-trademark').checked) ipArr.push('ìƒí‘œ'); if (document.getElementById('cb-design').checked) ipArr.push('ë””ìì¸'); if (document.getElementById('cb-ip-custom').checked) { var v = document.getElementById('in-ip-custom').value.trim(); if (v) ipArr.push(v); } var ipTypes = ipArr.join('/');
            var stage = ''; document.querySelectorAll('input[name="cb-stage"]:checked').forEach(function(cb){ stage = cb.id === 'cb-apply' ? 'ì¶œì›' : cb.id === 'cb-register' ? 'ë“±ë¡' : cb.id === 'cb-mid' ? 'ì¤‘ê°„ì‚¬ê±´' : (cb.id === 'cb-stage-custom' ? document.getElementById('in-stage-custom').value.trim() : stage); });
            var docTypes = ''; document.querySelectorAll('input[name="cb-doc"]:checked').forEach(function(cb){ docTypes = cb.id === 'cb-estimate' ? 'ê²¬ì ì„œ' : 'ì²­êµ¬ì„œ'; }); if (!docTypes) docTypes = 'ê²¬ì ì„œ';
            var mid = (ipTypes || '') + (stage ? ' ' + stage : ''); if (!mid.trim()) return;
            var t = mid.trim() + 'ì— ëŒ€í•œ ë¹„ìš© ' + docTypes + ' ì†¡ë¶€ì˜ ê±´';
            document.getElementById('in-title').value = t;
        }

        function handleExpiry(val) { 
            const dateInput = document.getElementById('in-expiry-date'); 
            let quoteDateVal = document.getElementById('in-quote-date').value;
            let targetDate = quoteDateVal ? new Date(quoteDateVal) : new Date(); 
            
            if(val === 'custom') {
                dateInput.classList.remove('hidden'); 
            } else { 
                dateInput.classList.add('hidden'); 
                targetDate.setDate(targetDate.getDate() + parseInt(val)); 
                dateInput.value = targetDate.toISOString().split('T')[0]; 
            }
            updatePreview(); 
        }

        function addRow() { items.push({ id: Date.now(), name: '', govPrice: 0, feePrice: 0, isGovTBD: false, note: 'íŠ¹í—ˆì²­ ì‹¤ë¹„ í¬í•¨', govText: '*ì²­êµ¬í•­ 5í•­ ê¸°ì¤€', feeText: '*ë¶€ê°€ì„¸ë³„ë„' }); renderInputs(); updatePreview(); }
        function removeRow(id) { items = items.filter(i => i.id !== id); renderInputs(); updatePreview(); }
        
        const TEMPLATE_KEY = 'teheran_quote_templates';
        function getTemplates() { try { return JSON.parse(localStorage.getItem(TEMPLATE_KEY) || '[]'); } catch { return []; } }
        function saveTemplates(arr) { localStorage.setItem(TEMPLATE_KEY, JSON.stringify(arr)); }
        function refreshTemplateSelect() {
            const sel = document.getElementById('template-select');
            const list = getTemplates();
            sel.innerHTML = '<option value="">â€” í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° â€”</option>' + list.map((t,i)=>`<option value="${i}">${t.name || 'í…œí”Œë¦¿ '+(i+1)}</option>`).join('');
        }
        function saveTemplate() {
            const name = prompt('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'ê²¬ì  í…œí”Œë¦¿ ' + (getTemplates().length + 1));
            if (!name) return;
            const t = {
                name,
                customer: document.getElementById('in-customer').value,
                phone: document.getElementById('in-phone').value,
                email: document.getElementById('in-email').value,
                senderName: document.getElementById('in-sender-name').value,
                senderPhone: document.getElementById('in-sender-phone').value,
                senderEmail: document.getElementById('in-sender-email').value,
                quoteDate: document.getElementById('in-quote-date').value,
                expiryOpt: document.getElementById('in-expiry-opt').value,
                expiryDate: document.getElementById('in-expiry-date').value,
                quoteInfo: document.getElementById('in-quote-info').value,
                title: document.getElementById('in-title').value,
                items: JSON.parse(JSON.stringify(items)),
                notices: [...notices],
                bankName: document.getElementById('in-bank-name').value,
                bankAccount: document.getElementById('in-bank-account').value,
                bankOwner: document.getElementById('in-bank-owner').value,
                manager: document.getElementById('in-manager').value,
                totalNote: document.getElementById('in-total-note').value
            };
            const list = getTemplates();
            list.push(t);
            saveTemplates(list);
            refreshTemplateSelect();
            alert('í…œí”Œë¦¿ "' + name + '" ì €ì¥ ì™„ë£Œ');
        }
        function loadTemplate(idx) {
            const i = parseInt(idx, 10);
            if (isNaN(i) || i < 0) return;
            const list = getTemplates();
            const t = list[i];
            if (!t) return;
            document.getElementById('in-customer').value = t.customer || '';
            document.getElementById('in-phone').value = t.phone || '';
            document.getElementById('in-email').value = t.email || '';
            document.getElementById('in-sender-name').value = t.senderName || '';
            document.getElementById('in-sender-phone').value = t.senderPhone || '';
            document.getElementById('in-sender-email').value = t.senderEmail || '';
            document.getElementById('in-quote-date').value = t.quoteDate || '';
            document.getElementById('in-expiry-opt').value = t.expiryOpt || '7';
            document.getElementById('in-expiry-date').value = t.expiryDate || '';
            document.getElementById('in-quote-info').value = t.quoteInfo || '';
            document.getElementById('in-title').value = t.title || '';
            items = (t.items && t.items.length) ? t.items.map((x,i)=>({...x, id: x.id || Date.now()+i})) : [{ id: Date.now(), name: '', govPrice: 0, feePrice: 0, isGovTBD: false, note: 'íŠ¹í—ˆì²­ ì‹¤ë¹„ í¬í•¨', govText: '*ì²­êµ¬í•­ 5í•­ ê¸°ì¤€', feeText: '*ë¶€ê°€ì„¸ë³„ë„' }];
            notices = Array.isArray(t.notices) ? [...t.notices] : notices;
            document.getElementById('in-bank-name').value = t.bankName || '';
            document.getElementById('in-bank-account').value = t.bankAccount || '';
            document.getElementById('in-bank-owner').value = t.bankOwner || '';
            document.getElementById('in-manager').value = t.manager || '';
            document.getElementById('in-total-note').value = t.totalNote || '';
            handleExpiry(document.getElementById('in-expiry-opt').value);
            renderInputs(); renderNotices(); updatePreview();
            document.getElementById('template-select').value = '';
        }
        function deleteTemplate() {
            const sel = document.getElementById('template-select');
            const i = parseInt(sel.value, 10);
            if (isNaN(i) || i < 0) { alert('ì‚­ì œí•  í…œí”Œë¦¿ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); return; }
            const list = getTemplates();
            const name = list[i]?.name || ('í…œí”Œë¦¿ ' + (i+1));
            if (!confirm('"' + name + '" í…œí”Œë¦¿ì„ ì‚­ì œí• ê¹Œìš”?')) return;
            list.splice(i, 1);
            saveTemplates(list);
            refreshTemplateSelect();
        }

        function renderInputs() {
            const container = document.getElementById('items-container'); container.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div'); div.className = 'p-3 bg-slate-50 border border-slate-200 rounded space-y-2 relative';
                div.innerHTML = `<button onclick="removeRow(${item.id})" class="absolute top-1.5 right-1.5 text-slate-300 hover:text-red-500 text-[10px]"><i class="fa-solid fa-xmark"></i></button>
                <div class="space-y-1">
                    <input type="text" class="admin-input font-bold" value="${item.name}" oninput="updateItem(${item.id}, 'name', this.value)" placeholder="ì„œë¹„ìŠ¤ í•­ëª©ëª…">
                    <input type="text" class="admin-input text-[10px] h-6" value="${item.note || ''}" oninput="updateItem(${item.id}, 'note', this.value)" placeholder="ë¹„ê³ ">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="space-y-1 p-2 bg-white rounded border border-slate-100">
                        <div class="flex items-center gap-1">
                            <input type="number" class="admin-input text-right text-[11px] flex-1" value="${item.govPrice}" oninput="updateItem(${item.id}, 'govPrice', this.value)" ${item.isGovTBD ? 'disabled' : ''}>
                            <label class="text-[9px]"><input type="checkbox" onchange="toggleTBD(${item.id}, this.checked)" ${item.isGovTBD ? 'checked' : ''}> ì¶”í›„</label>
                        </div>
                        <input type="text" class="admin-input text-[9px] h-5 opacity-70" value="${item.govText || ''}" oninput="updateItem(${item.id}, 'govText', this.value)" placeholder="ê´€ë‚©ë£Œ ì„¤ëª…">
                    </div>
                    <div class="space-y-1 p-2 bg-white rounded border border-slate-100">
                        <input type="number" class="admin-input text-right text-blue-600 font-bold text-[11px]" value="${item.feePrice}" oninput="updateItem(${item.id}, 'feePrice', this.value)" placeholder="ìˆ˜ìˆ˜ë£Œ">
                        <input type="text" class="admin-input text-[9px] h-5 opacity-70" value="${item.feeText || ''}" oninput="updateItem(${item.id}, 'feeText', this.value)" placeholder="ìˆ˜ìˆ˜ë£Œ ì„¤ëª…">
                    </div>
                </div>`;
                container.appendChild(div);
            });
        }
        function updateItem(id, field, value) { const item = items.find(x => x.id === id); if (item) { item[field] = (field === 'govPrice' || field === 'feePrice') ? Number(value) : value; updatePreview(); } }
        function toggleTBD(id, c) { const i = items.find(x=>x.id===id); i.isGovTBD = c; if(c) { i.govPrice = 0; i.note = 'â€» ëª…ì„¸ì„œ í™•ì • í›„ ì‹¤ë¹„ ì²­êµ¬'; } else { i.note = 'íŠ¹í—ˆì²­ ì‹¤ë¹„ í¬í•¨'; } renderInputs(); updatePreview(); }
        function addNotice() { notices.push(""); renderNotices(); updatePreview(); }
        function removeNotice(idx) { notices.splice(idx, 1); renderNotices(); updatePreview(); }
        function updateNotice(idx, val) { notices[idx] = val; updatePreview(); }
        function renderNotices() {
            const container = document.getElementById('notice-container'); container.innerHTML = '';
            notices.forEach((n, idx) => {
                const div = document.createElement('div'); div.className = 'flex gap-1.5';
                div.innerHTML = `<input type="text" class="admin-input text-[11px] flex-1" value="${n}" oninput="updateNotice(${idx}, this.value)"><button onclick="removeNotice(${idx})" class="text-slate-300 text-sm w-6 flex-shrink-0">Ã—</button>`;
                container.appendChild(div);
            });
        }
        function updatePreview() {
            document.getElementById('pv-customer').innerText = document.getElementById('in-customer').value || 'ìˆ˜ì‹ ì¸ ë¯¸ì…ë ¥';
            document.getElementById('pv-title').innerText = document.getElementById('in-title').value;
            document.getElementById('pv-phone').innerText = document.getElementById('in-phone').value ? `${document.getElementById('in-phone').value}` : '-';
            document.getElementById('pv-email').innerText = document.getElementById('in-email').value ? `${document.getElementById('in-email').value}` : '-';
            
            document.getElementById('pv-quote-info').innerText = document.getElementById('in-quote-info').value || '-';
            
            const quoteDateStr = document.getElementById('in-quote-date').value;
            document.getElementById('pv-today').innerText = quoteDateStr ? getFormattedDate(quoteDateStr) : '-';

            const expiryDateStr = document.getElementById('in-expiry-date').value;
            document.getElementById('pv-expiry-val').innerText = expiryDateStr ? getFormattedDate(expiryDateStr) : '-';
            
            document.getElementById('pv-sender-name').innerText = document.getElementById('in-sender-name').value;
            document.getElementById('pv-sender-phone').innerText = `${document.getElementById('in-sender-phone').value}`;
            document.getElementById('pv-sender-email').innerText = `${document.getElementById('in-sender-email').value}`;

            document.getElementById('pv-bank-name').innerText = document.getElementById('in-bank-name').value;
            // 1. DBì—ì„œ ê°€ì ¸ì™€ì„œ ì„ì‹œ ì €ì¥ëœ ê³„ì¢Œë²ˆí˜¸ê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
const fixedAcc = document.getElementById('pv-bank-account').getAttribute('data-fixed-account');

// 2. ë§Œì•½ DBì—ì„œ ê°€ì ¸ì˜¨ ê°’ì´ ìˆë‹¤ë©´ ê·¸ê±¸ ë³´ì—¬ì£¼ê³ , ì—†ìœ¼ë©´ ê¸°ì¡´ì²˜ëŸ¼ ì…ë ¥ì°½(ë˜ëŠ” ê¸°ë³¸ê°’)ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
if (fixedAcc) {
    document.getElementById('pv-bank-account').innerText = fixedAcc;
} else {
    // ê¸°ì¡´ ë¡œì§ ìœ ì§€ (ì…ë ¥ì°½ì´ ìˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„)
    const bankInput = document.getElementById('in-bank-account');
    document.getElementById('pv-bank-account').innerText = bankInput ? bankInput.value : "ì‹ í•œì€í–‰ 110-534-846872 (íŠ¹í—ˆë²•ì¸ í…Œí—¤ë€)";
}
            document.getElementById('pv-bank-owner').innerText = document.getElementById('in-bank-owner').value;
            document.getElementById('pv-manager').innerText = document.getElementById('in-manager').value;
            
            document.getElementById('pv-total-note').innerText = document.getElementById('in-total-note').value;

            const tbody = document.getElementById('pv-table-body'); tbody.innerHTML = '';
            let tGov = 0, tFee = 0;
            items.forEach(item => {
                const govDisp = item.isGovTBD ? '<span class="text-slate-400 italic text-xs">ì¶”í›„ì²­êµ¬</span>' : new Intl.NumberFormat('ko-KR').format(item.govPrice);
                
                // [ìˆ˜ì •] í…Œì´ë¸” ë ˆì´ì•„ì›ƒ: Block ë°°ì¹˜ (ìœ„ì•„ë˜)
                tbody.insertAdjacentHTML('beforeend', `<tr>
                    <td>
                        <div class="font-bold text-slate-800 text-[14px]">${item.name || 'ë¯¸ì…ë ¥'}</div>
                        <div class="text-[10px] text-slate-400 mt-0.5">${item.note || ''}</div>
                    </td>
                    <td class="col-gov">
                        <div class="text-slate-500 font-medium">${govDisp}</div>
                        <div class="text-[9px] text-slate-400 font-medium mt-0.5">${item.govText || ''}</div>
                    </td>
                    <td class="col-fee">
                        <div class="text-slate-900 font-bold">${new Intl.NumberFormat('ko-KR').format(item.feePrice)}</div>
                        <div class="text-[9px] text-slate-400 font-medium mt-0.5">${item.feeText || ''}</div>
                    </td>
                </tr>`);
                tGov += item.govPrice; tFee += item.feePrice;
            });
            const grandTotal = Math.round(tFee * 1.1) + tGov;
            document.getElementById('pv-total').innerText = 'â‚© ' + new Intl.NumberFormat('ko-KR').format(grandTotal);
            document.getElementById('admin-total-preview').innerText = 'â‚© ' + new Intl.NumberFormat('ko-KR').format(grandTotal);
            document.getElementById('pv-notice').innerHTML = notices.map(n => `<div>${n}</div>`).join('');
        }

        function sendToGoogleSheet(sheetRows) {
        if (!GOOGLE_SHEETS_WEBHOOK) return;

        const payload = { rows: sheetRows };

        fetch(GOOGLE_SHEETS_WEBHOOK, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
        }).catch(function (e) {
            console.warn('êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ ì‹¤íŒ¨:', e);
        });
        }


        function testGoogleSheet() {
            if (!GOOGLE_SHEETS_WEBHOOK) return alert('GOOGLE_SHEETS_WEBHOOKê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            const q = { phone: document.getElementById('in-phone').value, email: document.getElementById('in-email').value, quote_info: document.getElementById('in-quote-info').value, quote_date: document.getElementById('in-quote-date').value, expiry: document.getElementById('in-expiry-date').value, title: document.getElementById('in-title').value, sender: { name: document.getElementById('in-sender-name').value } };
            const tGov = (items || []).reduce((s, i) => s + (i.govPrice || 0), 0);
            const tFee = (items || []).reduce((s, i) => s + (i.feePrice || 0), 0);
            const grandTotal = Math.round(tFee * 1.1) + tGov;
            const costItems = (items && items.length) ? items : [{ govPrice: 0, feePrice: 0 }];
            // [ADD] Aì—´ ê²¬ì ì„œ/ì²­êµ¬ì„œ, VAT(Kì—´)
            var docType = document.getElementById('cb-estimate').checked ? 'ê²¬ì ì„œ' : (document.getElementById('cb-invoice').checked ? 'ì²­êµ¬ì„œ' : '');
            const sheetRows = costItems.map(it => {
                const agentFeeVal = typeof it.feePrice === 'string' ? Number(String(it.feePrice || 0).replace(/,/g, '')) : (it.feePrice || 0);
                const vat = isNaN(agentFeeVal) ? 0 : Math.round(agentFeeVal * 0.1);
                return { docType: docType, recipient: document.getElementById('in-customer').value || '', phone: q.phone || '', email: q.email || '', attorney: (q.sender && q.sender.name) ? q.sender.name : '', quoteDate: q.quote_date || '', expiry: q.expiry || '', quoteInfo: q.quote_info || '', title: q.title || '', govFee: it.govPrice || 0, agentFee: it.feePrice || 0, "ë¶€ê°€ì„¸": vat, total: grandTotal, link: '[í…ŒìŠ¤íŠ¸] ' + window.location.origin };
            });
            sendToGoogleSheet(sheetRows);
            alert('ì „ì†¡ ì™„ë£Œ. êµ¬ê¸€ ì‹œíŠ¸ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ í™•ì¸í•´ë³´ì„¸ìš”.');
        }
        
        async function publishQuote() {
            if (!_supabase) return alert("Supabase ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ë„¤íŠ¸ì›Œí¬/ì½˜ì†” í™•ì¸)");
            const customer = document.getElementById('in-customer').value; if(!customer) return alert("ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            const btn = document.getElementById('btn-publish'); btn.innerText = "ì €ì¥ ì¤‘..."; btn.disabled = true;

            // client_id í™•ë³´ (ì„ íƒëœ ê¸°ì¡´ ê³ ê° or ì‹ ê·œ ìë™ ë“±ë¡)
            let clientId = currentClientId;
            if (!clientId && _supabase) {
                try {
                    const { data: existing } = await _supabase
                        .from('clients').select('id').eq('name', customer).maybeSingle();
                    if (existing) {
                        clientId = existing.id;
                    } else {
                        const { data: created } = await _supabase
                            .from('clients')
                            .insert([{
                                name:  customer,
                                phone: document.getElementById('in-phone').value.trim() || null,
                                email: document.getElementById('in-email').value.trim() || null
                            }])
                            .select().single();
                        if (created) clientId = created.id;
                    }
                } catch(e) { console.warn('Client upsert error:', e); }
            }
            const docType = document.getElementById('cb-estimate').checked ? 'ê²¬ì ì„œ'
                          : document.getElementById('cb-invoice').checked  ? 'ì²­êµ¬ì„œ' : 'ê²¬ì ì„œ';

            const sealImg = document.getElementById('pv-seal-img');
            const sealDataURL = (sealImg.style.display !== 'none' && sealImg.src) ? sealImg.src : null;
            const logoImg = document.getElementById('pv-logo');
            const logoDataURL = (logoImg.style.display !== 'none' && logoImg.src) ? logoImg.src : null;

            let logoUrl = null, sealUrl = null;
            let logoData = null, sealData = null;
            if (logoDataURL && logoDataURL.startsWith('data:')) {
                const compressed = await compressImage(logoDataURL, 600);
                const res = await uploadImageToStorage(compressed, 'logo');
                if (typeof res === 'string') logoUrl = res;
                else { logoData = compressed; if (res && res.error) console.warn('ë¡œê³  Storage ì‹¤íŒ¨:', res.error); }
            }
            if (sealDataURL && sealDataURL.startsWith('data:')) {
                const compressed = await compressImage(sealDataURL, 400);
                const res = await uploadImageToStorage(compressed, 'seal');
                if (typeof res === 'string') sealUrl = res;
                else { sealData = compressed; if (res && res.error) console.warn('ë„ì¥ Storage ì‹¤íŒ¨:', res.error); }
            }

            const shareToken = crypto.randomUUID();
            const payload = {
                customer_name: customer,
                share_token: shareToken,
                client_id: clientId || null,
                doc_type: docType,
                quote_data: {
                    title: document.getElementById('in-title').value, 
                    email: document.getElementById('in-email').value, 
                    phone: document.getElementById('in-phone').value, 
                    quote_info: document.getElementById('in-quote-info').value,
                    quote_date: document.getElementById('in-quote-date').value,
                    total_note: document.getElementById('in-total-note').value,
                    
                    sender: {
                        name: document.getElementById('in-sender-name').value,
                        phone: document.getElementById('in-sender-phone').value,
                        email: document.getElementById('in-sender-email').value
                    },

                    expiry: document.getElementById('in-expiry-date').value, 
                    items: items, 
                    notices: notices, 
                    bank: { 
                        name: document.getElementById('in-bank-name').value, 
                        account: document.getElementById('in-bank-account').value, 
                        owner: document.getElementById('in-bank-owner').value, 
                        manager: document.getElementById('in-manager').value 
                    },
                    logoUrl: logoUrl,
                    sealUrl: sealUrl,
                    logoData: logoData,
                    sealData: sealData 
                } 
            };
            const { data, error } = await _supabase.from('quotes').insert([payload]).select();
            if (error) { alert("ì €ì¥ ì‹¤íŒ¨: " + (error.message || '')); btn.innerText = "ê²¬ì ì„œ ë°œí–‰ ë° ë§í¬ ë³µì‚¬"; btn.disabled = false; return; }
            const token = data[0].share_token || data[0].id;
            const fullLink = `${window.location.origin}${window.location.pathname}?token=${token}`;
            payload._shareLink = fullLink;

            if (GOOGLE_SHEETS_WEBHOOK) {
                try {
                    const q = payload.quote_data || {};
                    const tGov = (items || []).reduce((s, i) => s + (i.govPrice || 0), 0);
                    const tFee = (items || []).reduce((s, i) => s + (i.feePrice || 0), 0);
                    const grandTotal = Math.round(tFee * 1.1) + tGov;
                    const costItems = (items && items.length) ? items : [{ govPrice: 0, feePrice: 0 }];
                    // [ADD] Aì—´ ê²¬ì ì„œ/ì²­êµ¬ì„œ, VAT(Kì—´)
                    // docTypeì€ publishQuote ìƒë‹¨ì—ì„œ ì´ë¯¸ ì„ ì–¸ë¨
                    const sheetRows = costItems.map(it => {
                        const agentFeeVal = typeof it.feePrice === 'string' ? Number(String(it.feePrice || 0).replace(/,/g, '')) : (it.feePrice || 0);
                        const vat = isNaN(agentFeeVal) ? 0 : Math.round(agentFeeVal * 0.1);
                        return {
                            docType: docType,
                            recipient: payload.customer_name || '',
                            phone: q.phone || '',
                            email: q.email || '',
                            attorney: (q.sender && q.sender.name) ? q.sender.name : '',
                            quoteDate: q.quote_date || '',
                            expiry: q.expiry || '',
                            quoteInfo: q.quote_info || '',
                            title: q.title || '',
                            govFee: it.govPrice || 0,
                            agentFee: it.feePrice || 0,
                            "ë¶€ê°€ì„¸": vat,
                            total: grandTotal,
                            link: fullLink
                        };
                    });
                    sendToGoogleSheet(sheetRows);
                } catch (e) { console.warn('êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™:', e); }
            }
            navigator.clipboard.writeText(fullLink);
            alert(`âœ… ë°œí–‰ ì„±ê³µ ë° ì£¼ì†Œ ë³µì‚¬ ì™„ë£Œ!\n\n${fullLink}`);
            btn.innerText = "ê²¬ì ì„œ ë°œí–‰ ë° ë§í¬ ë³µì‚¬";
            btn.disabled = false;
        }

        const DEFAULTS = { customer: 'ê¹€ì§„ì™• ì›ì¥', phone: '010-1234-5678', email: 'jinwang.kim@teheran-sample.com', title: 'íŠ¹í—ˆì¶œì› ë¹„ìš© ê²¬ì ì„œ ì†¡ë¶€ì˜ ê±´', quoteInfo: 'ì‹ ê·œ, íŠ¹í—ˆì¶œì›, ìš°ì„ ì‹¬ì‚¬, 1ê±´', bankName: 'ì‹ í•œì€í–‰', bankAccount: '140-012-565030', bankOwner: 'íŠ¹í—ˆë²•ì¸ í…Œí—¤ë€', manager: 'ê´€ë¦¬íŒ€ ë°•ì†”ì•„ì°¨ì¥', senderName: 'ìœ¤ì›…ì±„', senderPhone: '010-8875-4370', senderEmail: 'wcyoon@thrlaw.co.kr', totalNote: 'ê´€ë‚©ë£Œ, ìˆ˜ìˆ˜ë£Œ, ë¶€ê°€ê°€ì¹˜ì„¸(10%) í¬í•¨' };

        async function checkUrlAndLoad() {
            if (!_supabase) return;
            const params = new URLSearchParams(window.location.search);

            // clients.htmlì—ì„œ ê²¬ì ì„œ ì‘ì„± ë²„íŠ¼ìœ¼ë¡œ ë„˜ì–´ì˜¬ ë•Œ prefill ì²˜ë¦¬
            const prefillName     = params.get('prefill_name');
            const prefillPhone    = params.get('prefill_phone');
            const prefillEmail    = params.get('prefill_email');
            const prefillClientId = params.get('client_id');
            if (prefillName || prefillPhone || prefillEmail) {
                if (prefillName)     document.getElementById('in-customer').value = prefillName;
                if (prefillPhone)    document.getElementById('in-phone').value    = prefillPhone;
                if (prefillEmail)    document.getElementById('in-email').value    = prefillEmail;
                if (prefillClientId) currentClientId = prefillClientId;
                updatePreview();
                // URL íŒŒë¼ë¯¸í„°ë¥¼ íˆìŠ¤í† ë¦¬ì—ì„œ ì œê±° (ì„ íƒ)
                history.replaceState(null, '', window.location.pathname);
                return;
            }

            const token = params.get('token') || params.get('id');
            if (!token) return;
            document.querySelector('aside').style.display = 'none';
            const divider = document.getElementById('mobile-preview-divider');
            if (divider) divider.style.display = 'none';
            const isNumeric = /^\d+$/.test(token);
            const { data } = await _supabase.from('quotes').select('*')
                .eq(isNumeric ? 'id' : 'share_token', isNumeric ? parseInt(token, 10) : token).single();
            if (data) {
                    const todayStr = new Date().toISOString().split('T')[0];
                    const q = data.quote_data || {};
                    document.getElementById('in-customer').value = data.customer_name || DEFAULTS.customer;
                    document.getElementById('in-title').value = q.title || DEFAULTS.title;
                    document.getElementById('in-email').value = q.email || DEFAULTS.email;
                    document.getElementById('in-phone').value = q.phone || DEFAULTS.phone;
                    document.getElementById('in-quote-date').value = q.quote_date || todayStr;
                    document.getElementById('in-expiry-date').value = q.expiry || '';
                    if (!q.expiry) handleExpiry(document.getElementById('in-expiry-opt').value);
                    document.getElementById('in-quote-info').value = q.quote_info || DEFAULTS.quoteInfo;
                    document.getElementById('in-total-note').value = q.total_note || DEFAULTS.totalNote;
                    if (q.sender) {
                        document.getElementById('in-sender-name').value = q.sender.name || DEFAULTS.senderName;
                        document.getElementById('in-sender-phone').value = q.sender.phone || DEFAULTS.senderPhone;
                        document.getElementById('in-sender-email').value = q.sender.email || DEFAULTS.senderEmail;
                    }
                    const loadedItems = q.items;
                    items = (Array.isArray(loadedItems) && loadedItems.length > 0) ? loadedItems : items;
                    notices = (Array.isArray(q.notices) && q.notices.length > 0) ? q.notices : notices;
                    if (q.bank) {
                        document.getElementById('in-bank-name').value = q.bank.name || DEFAULTS.bankName;
                        document.getElementById('in-bank-account').value = q.bank.account || DEFAULTS.bankAccount;
                        document.getElementById('in-bank-owner').value = q.bank.owner || DEFAULTS.bankOwner;
                        document.getElementById('in-manager').value = q.bank.manager || DEFAULTS.manager;
                    }
                    
                    const sealSrc = data.quote_data.sealUrl || data.quote_data.sealData;
                    if (sealSrc) {
                        const img = document.getElementById('pv-seal-img');
                        img.src = sealSrc;
                        img.style.display = 'block';
                    }
                    const logoSrc = data.quote_data.logoUrl || data.quote_data.logoData;
                    if (logoSrc) {
                        const img = document.getElementById('pv-logo');
                        img.src = logoSrc;
                        img.style.display = 'block';
                        document.getElementById('pv-logo-text').style.display = 'none';
                        toggleLogoFilter(document.getElementById('logo-filter-check').checked);
                    }

                    renderInputs(); renderNotices(); updatePreview();
            }
        }
        function resetAll() { 
            if(confirm('ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê¸°ë³¸ ì˜ˆì‹œë¡œ ë³µì›ë©ë‹ˆë‹¤)')) { 
                const todayStr = new Date().toISOString().split('T')[0];
                document.getElementById('in-customer').value = 'ê¹€ì§„ì™• ì›ì¥';
                document.getElementById('in-phone').value = '010-1234-5678';
                document.getElementById('in-email').value = 'jinwang.kim@teheran-sample.com';
                document.getElementById('in-title').value = 'íŠ¹í—ˆì¶œì› ë¹„ìš© ê²¬ì ì„œ ì†¡ë¶€ì˜ ê±´';
                document.getElementById('in-quote-info').value = 'ì‹ ê·œ, íŠ¹í—ˆì¶œì›, ìš°ì„ ì‹¬ì‚¬, 1ê±´';
                document.getElementById('in-quote-date').value = todayStr;
                handleExpiry('7');
                items = [{ id: Date.now(), name: 'íŠ¹í—ˆì¶œì› (ë°”ì´ì˜¤ëª¨ë“ˆë ˆì´í„°)', govPrice: 46000, feePrice: 1500000, isGovTBD: false, note: 'íŠ¹í—ˆì²­ ì‹¤ë¹„ í¬í•¨', govText: '*ì²­êµ¬í•­ 5í•­ ê¸°ì¤€', feeText: '*ë¶€ê°€ì„¸ë³„ë„' }];
                notices = ["â€¢ ë³¸ ê²¬ì  ê¸ˆì•¡ì—ëŠ” ëŒ€ë¦¬ì¸ ìˆ˜ìˆ˜ë£Œì— ëŒ€í•œ ë¶€ê°€ê°€ì¹˜ì„¸(10%)ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.", "â€¢ ê´€ë‚©ë£ŒëŠ” êµ­ê°€ ì‹¤ë¹„ë¡œì„œ, ê³ ê°ì‚¬ì˜ ê°ë©´ ì¡°ê±´ì— ë”°ë¼ ì‹¤ì œ ë‚©ë¶€ ì‹œì ì— ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "â€¢ ì°©ìˆ˜ê¸ˆ ì…ê¸ˆ í™•ì¸ í›„ ì—…ë¬´ê°€ ê³µì‹ì ìœ¼ë¡œ ê°œì‹œë©ë‹ˆë‹¤."];
                document.querySelectorAll('input[name="cb-newold"], input[name="cb-stage"], input[name="cb-exam"]').forEach(function(cb){ cb.checked = false; });
                document.getElementById('cb-new').checked = true; document.getElementById('cb-patent').checked = true; document.getElementById('cb-apply').checked = true; document.getElementById('cb-priority').checked = true; document.getElementById('cb-estimate').checked = true; document.getElementById('cb-invoice').checked = false; document.getElementById('cb-count1').checked = true; document.getElementById('cb-count2').checked = false; document.getElementById('cb-count-custom').checked = false; document.getElementById('cb-utility').checked = false; document.getElementById('cb-trademark').checked = false; document.getElementById('cb-design').checked = false; document.getElementById('cb-ip-custom').checked = false; document.getElementById('cb-register').checked = false; document.getElementById('cb-mid').checked = false; document.getElementById('cb-stage-custom').checked = false; document.getElementById('cb-normal').checked = false; document.getElementById('in-ip-custom').classList.add('hidden'); document.getElementById('in-stage-custom').classList.add('hidden'); document.getElementById('in-count-custom').classList.add('hidden');
                renderInputs(); renderNotices(); updatePreview(); 
            } 
        }
        function loadSample() {
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('in-customer').value = 'ê¹€ì§„ì™• ì›ì¥';
            document.getElementById('in-phone').value = '010-1234-5678';
            document.getElementById('in-email').value = 'jinwang.kim@teheran-sample.com';
            document.getElementById('in-title').value = 'íŠ¹í—ˆì¶œì› ë¹„ìš© ê²¬ì ì„œ ì†¡ë¶€ì˜ ê±´';
            document.getElementById('in-quote-info').value = 'ì‹ ê·œ, íŠ¹í—ˆì¶œì›, ìš°ì„ ì‹¬ì‚¬, 1ê±´';
            document.getElementById('in-quote-date').value = todayStr;
            handleExpiry('7');
            items = [{ id: Date.now(), name: 'íŠ¹í—ˆì¶œì› (ë°”ì´ì˜¤ëª¨ë“ˆë ˆì´í„°)', govPrice: 46000, feePrice: 1500000, isGovTBD: false, note: 'íŠ¹í—ˆì²­ ì‹¤ë¹„ í¬í•¨', govText: '*ì²­êµ¬í•­ 5í•­ ê¸°ì¤€', feeText: '*ë¶€ê°€ì„¸ë³„ë„' }];
            document.getElementById('cb-new').checked = true; document.getElementById('cb-patent').checked = true; document.getElementById('cb-apply').checked = true; document.getElementById('cb-priority').checked = true; document.getElementById('cb-estimate').checked = true; document.getElementById('cb-count1').checked = true;
            renderInputs(); updatePreview();
        }
        try { init(); whenSupabaseReady(); } catch(e) { console.error('Init error:', e); var d=new Date(); var el=document.getElementById('in-quote-date'); if(el)el.value=d.toISOString().split('T')[0]; }
    </script>
</body>
</html>