<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>특허법인 테헤란 | 고객 관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" async></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --navy: #001A35; --blue: #2563EB; }
        body  { font-family: 'Pretendard', sans-serif; }

        .admin-input {
            border: 1px solid #E2E8F0; border-radius: 4px;
            padding: 5px 9px; font-size: 12px; outline: none; transition: all .2s;
        }
        .admin-input:focus { border-color: var(--blue); box-shadow: 0 0 0 2px rgba(37,99,235,.1); }

        /* 테이블 */
        .data-table { border-collapse: collapse; width: 100%; font-size: 12px; }
        .data-table thead th {
            background: var(--navy); color: #fff; font-weight: 700;
            padding: 9px 10px; text-align: left; white-space: nowrap;
            position: sticky; top: 0; z-index: 10;
        }
        .data-table tbody tr { border-bottom: 1px solid #F1F5F9; transition: background .1s; }
        .data-table tbody tr:hover { background: #EFF6FF; }
        .data-table tbody td { padding: 8px 10px; vertical-align: middle; }

        .badge-unpaid { background:#FEE2E2; color:#DC2626; font-size:10px; font-weight:700; padding:2px 7px; border-radius:9999px; }
        .badge-paid   { background:#D1FAE5; color:#059669; font-size:10px; font-weight:700; padding:2px 7px; border-radius:9999px; }
        .badge-est    { background:#DBEAFE; color:#1D4ED8; font-size:10px; font-weight:700; padding:2px 7px; border-radius:9999px; }
        .badge-inv    { background:#1E293B; color:#F8FAFC; font-size:10px; font-weight:700; padding:2px 7px; border-radius:9999px; }

        .toggle-btn {
            font-size: 10px; border: 1px solid #E2E8F0; border-radius: 4px;
            padding: 2px 6px; cursor: pointer; background: white;
            color: #64748B; transition: all .15s; white-space: nowrap;
        }
        .toggle-btn:hover { background: #F1F5F9; }

        /* 탭 */
        .tab-btn { padding: 6px 14px; font-size: 12px; font-weight: 700; border-bottom: 2px solid transparent; color: #94A3B8; cursor: pointer; }
        .tab-btn.active { border-bottom-color: var(--blue); color: var(--blue); }
    </style>
</head>
<body class="antialiased bg-slate-50 text-slate-800 overflow-hidden">

<!-- ── 상단 네비 ── -->
<header style="background:var(--navy)" class="text-white flex items-center justify-between px-5 py-2.5 shadow-lg z-30 relative flex-shrink-0">
    <div class="flex items-center gap-4">
        <a href="index.html" class="text-white/60 hover:text-white text-xs transition flex items-center gap-1.5">
            <i class="fa-solid fa-file-invoice-dollar"></i>견적 작성
        </a>
        <span class="text-white/20">|</span>
        <h1 class="font-bold text-sm tracking-tight">
            <i class="fa-solid fa-table mr-1.5 text-blue-400"></i>고객 &amp; 발행 현황
        </h1>
    </div>
    <button onclick="openNewModal()"
        class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-3 py-1.5 rounded-lg transition flex items-center gap-1.5">
        <i class="fa-solid fa-plus"></i> 고객 등록
    </button>
</header>

<!-- ── 필터 바 ── -->
<div class="bg-white border-b border-slate-200 px-5 py-2 flex items-center gap-3 flex-wrap flex-shrink-0">

    <!-- 탭: 발행이력 / 고객목록 -->
    <div class="flex border-b-0 gap-0 mr-2">
        <button onclick="switchView('quotes')" id="tab-quotes" class="tab-btn active">
            <i class="fa-solid fa-file-invoice-dollar mr-1"></i>발행 이력
        </button>
        <button onclick="switchView('clients')" id="tab-clients" class="tab-btn">
            <i class="fa-solid fa-users mr-1"></i>고객 목록
        </button>
    </div>

    <div class="w-px h-5 bg-slate-200"></div>

    <!-- 검색 -->
    <div class="relative">
        <i class="fa-solid fa-magnifying-glass absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-[10px]"></i>
        <input type="text" id="search-input" placeholder="고객명 검색..."
            oninput="applyFilter()" class="admin-input pl-7 w-40">
    </div>

    <!-- 타입 필터 -->
    <div class="flex gap-1">
        <button id="f-all"   onclick="setTypeFilter('all')"
            class="text-[10px] font-bold px-2.5 py-1 rounded bg-blue-600 text-white">전체</button>
        <button id="f-corp"  onclick="setTypeFilter('법인')"
            class="text-[10px] font-bold px-2.5 py-1 rounded border border-slate-200 text-slate-500 hover:bg-slate-50">법인</button>
        <button id="f-indiv" onclick="setTypeFilter('개인')"
            class="text-[10px] font-bold px-2.5 py-1 rounded border border-slate-200 text-slate-500 hover:bg-slate-50">개인</button>
    </div>

    <!-- 납부상태 필터 (발행이력 탭에서만) -->
    <div id="pay-filter" class="flex gap-1">
        <button id="f-pay-all"    onclick="setPayFilter('all')"
            class="text-[10px] font-bold px-2.5 py-1 rounded bg-slate-700 text-white">전체</button>
        <button id="f-pay-unpaid" onclick="setPayFilter('미납')"
            class="text-[10px] font-bold px-2.5 py-1 rounded border border-slate-200 text-slate-500 hover:bg-slate-50">미납</button>
        <button id="f-pay-paid"   onclick="setPayFilter('완납')"
            class="text-[10px] font-bold px-2.5 py-1 rounded border border-slate-200 text-slate-500 hover:bg-slate-50">완납</button>
    </div>

    <div class="ml-auto text-[11px] text-slate-400">
        총 <span id="row-count" class="font-bold text-blue-600">0</span>건
    </div>
</div>

<!-- ── 메인 테이블 영역 ── -->
<div style="height:calc(100vh - 90px)" class="overflow-auto">

    <!-- 발행이력 테이블 -->
    <div id="view-quotes">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width:80px">발행일</th>
                    <th style="width:70px">고객코드</th>
                    <th style="width:120px">고객명</th>
                    <th style="width:110px">연락처</th>
                    <th style="width:160px">이메일</th>
                    <th style="width:70px">담당변리사</th>
                    <th style="width:55px">종류</th>
                    <th style="min-width:160px">견적정보</th>
                    <th style="width:90px; text-align:right">청구금액</th>
                    <th style="width:80px">납부상태</th>
                    <th style="width:80px">입금확인일</th>
                    <th style="width:50px">링크</th>
                </tr>
            </thead>
            <tbody id="quotes-tbody">
                <tr><td colspan="12" class="text-center py-10 text-slate-400">불러오는 중...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- 고객목록 테이블 -->
    <div id="view-clients" class="hidden">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width:70px">고객코드</th>
                    <th style="width:120px">고객명</th>
                    <th style="width:60px">유형</th>
                    <th style="width:100px">담당자</th>
                    <th style="width:110px">연락처</th>
                    <th style="width:160px">이메일</th>
                    <th style="width:110px">사업자번호</th>
                    <th style="width:80px">담당변리사</th>
                    <th style="width:60px">발행건수</th>
                    <th style="width:80px">상태</th>
                    <th style="width:80px">등록일</th>
                    <th style="width:90px">액션</th>
                </tr>
            </thead>
            <tbody id="clients-tbody">
                <tr><td colspan="12" class="text-center py-10 text-slate-400">불러오는 중...</td></tr>
            </tbody>
        </table>
    </div>

</div>

<!-- ── 고객 등록/수정 모달 ── -->
<div id="client-modal" class="fixed inset-0 z-50 hidden items-center justify-center"
     style="background:rgba(0,0,0,.45)">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
        <div style="background:var(--navy)" class="text-white px-5 py-4 flex items-center justify-between">
            <h3 id="modal-title" class="font-bold text-sm">고객 등록</h3>
            <button onclick="closeModal()" class="text-white/60 hover:text-white">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
        </div>
        <div class="p-5 space-y-3 max-h-[65vh] overflow-y-auto">
            <div class="grid grid-cols-2 gap-3">
                <div class="col-span-2">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">고객명 *</label>
                    <input type="text" id="m-name" class="admin-input w-full" placeholder="고객명 (필수)">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">고객 유형</label>
                    <select id="m-type" class="admin-input w-full">
                        <option value="">선택</option>
                        <option value="법인">법인</option>
                        <option value="개인">개인</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">담당자명</label>
                    <input type="text" id="m-contact" class="admin-input w-full" placeholder="담당자명">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">연락처</label>
                    <input type="text" id="m-phone" class="admin-input w-full" placeholder="010-0000-0000">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">이메일</label>
                    <input type="email" id="m-email" class="admin-input w-full" placeholder="email@example.com">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">사업자번호</label>
                    <input type="text" id="m-biz-no" class="admin-input w-full" placeholder="000-00-00000">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">담당 변리사</label>
                    <input type="text" id="m-attorney" class="admin-input w-full" placeholder="담당 변리사">
                </div>
                <div class="col-span-2">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">메모</label>
                    <textarea id="m-memo" class="admin-input w-full h-14 resize-none" placeholder="메모"></textarea>
                </div>
            </div>
        </div>
        <div class="px-5 py-3 border-t border-slate-100 flex justify-end gap-2">
            <button onclick="closeModal()"
                class="px-4 py-1.5 border border-slate-200 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-50">취소</button>
            <button onclick="saveClient()"
                class="px-4 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-500 transition">저장</button>
        </div>
    </div>
</div>

<!-- ── JavaScript ── -->
<script>
const SUPABASE_URL = 'https://pduhmdgsgtihrbwzrcjo.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkdWhtZGdzZ3RpaHJid3pyY2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMDM1ODAsImV4cCI6MjA4NzU3OTU4MH0.86pwEjfm4qmTZulCBYabRpm-Z6fKgL44p1Y9fo9jjwo';

let _supabase    = null;
let allQuotes    = [];   // 발행이력 (클라이언트 정보 join)
let allClients   = [];   // 고객목록
let activeView   = 'quotes';
let typeFilter   = 'all';
let payFilter    = 'all';
let editingId    = null;

// ── 초기화 ──
function whenSupabaseReady() {
    if (typeof supabase !== 'undefined') {
        try { _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); loadAll(); }
        catch(e) { console.error(e); }
        return;
    }
    const t = setInterval(function() {
        if (typeof supabase !== 'undefined') {
            clearInterval(t);
            try { _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); loadAll(); }
            catch(e) {}
        }
    }, 100);
    setTimeout(function() { clearInterval(t); }, 8000);
}

async function loadAll() {
    await Promise.all([loadQuotes(), loadClients()]);
}

// ── 발행이력 로드 (clients JOIN) ──
async function loadQuotes() {
    if (!_supabase) return;
    const { data, error } = await _supabase
        .from('quotes')
        .select('*, clients(id, client_code, name, phone, email, assigned_attorney, client_type)')
        .order('created_at', { ascending: false });
    if (error) { console.error(error); return; }
    allQuotes = data || [];
    if (activeView === 'quotes') renderQuotes();
}

// ── 고객목록 로드 ──
async function loadClients() {
    if (!_supabase) return;
    const { data, error } = await _supabase
        .from('clients')
        .select('*')
        .order('created_at', { ascending: false });
    if (error) { console.error(error); return; }
    allClients = data || [];
    if (activeView === 'clients') renderClients();
}

// ── 탭 전환 ──
function switchView(view) {
    activeView = view;
    document.getElementById('view-quotes').classList.toggle('hidden', view !== 'quotes');
    document.getElementById('view-clients').classList.toggle('hidden', view !== 'clients');
    document.getElementById('tab-quotes').className  = 'tab-btn ' + (view === 'quotes'  ? 'active' : '');
    document.getElementById('tab-clients').className = 'tab-btn ' + (view === 'clients' ? 'active' : '');
    document.getElementById('pay-filter').classList.toggle('hidden', view !== 'quotes');
    applyFilter();
}

// ── 필터 적용 ──
function applyFilter() {
    if (activeView === 'quotes')  renderQuotes();
    else                          renderClients();
}

function setTypeFilter(t) {
    typeFilter = t;
    ['f-all','f-corp','f-indiv'].forEach(function(id) {
        document.getElementById(id).className =
            'text-[10px] font-bold px-2.5 py-1 rounded border border-slate-200 text-slate-500 hover:bg-slate-50';
    });
    document.getElementById(t === 'all' ? 'f-all' : t === '법인' ? 'f-corp' : 'f-indiv').className =
        'text-[10px] font-bold px-2.5 py-1 rounded bg-blue-600 text-white';
    applyFilter();
}

function setPayFilter(p) {
    payFilter = p;
    ['f-pay-all','f-pay-unpaid','f-pay-paid'].forEach(function(id) {
        document.getElementById(id).className =
            'text-[10px] font-bold px-2.5 py-1 rounded border border-slate-200 text-slate-500 hover:bg-slate-50';
    });
    document.getElementById(p === 'all' ? 'f-pay-all' : p === '미납' ? 'f-pay-unpaid' : 'f-pay-paid').className =
        'text-[10px] font-bold px-2.5 py-1 rounded bg-slate-700 text-white';
    applyFilter();
}

// ── 발행이력 렌더링 ──
function renderQuotes() {
    const q   = (document.getElementById('search-input').value || '').toLowerCase();
    let rows  = allQuotes;

    // 검색
    if (q) rows = rows.filter(function(r) {
        const name = ((r.clients && r.clients.name) || r.customer_name || '').toLowerCase();
        return name.includes(q);
    });
    // 타입 필터
    if (typeFilter !== 'all') rows = rows.filter(function(r) {
        return r.clients && r.clients.client_type === typeFilter;
    });
    // 납부상태 필터
    if (payFilter !== 'all') rows = rows.filter(function(r) {
        return (r.pay_status || '미납') === payFilter;
    });

    document.getElementById('row-count').innerText = rows.length;
    const tbody = document.getElementById('quotes-tbody');

    if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="text-center py-10 text-slate-400 text-xs">데이터가 없습니다.</td></tr>';
        return;
    }

    tbody.innerHTML = rows.map(function(r) {
        const c        = r.clients || {};
        const qd       = r.quote_data || {};
        const total    = calcTotal(qd);
        const isPaid   = r.pay_status === '완납';
        const date     = r.created_at ? r.created_at.slice(0,10) : '-';
        const paidDate = r.paid_at    ? r.paid_at.slice(0,10) : '';
        const shareLink= r.share_token ? 'index.html?token=' + r.share_token : '';
        const quoteInfo= qd.quote_info || qd.title || '-';

        return '<tr>'
            + '<td class="text-slate-500">' + date + '</td>'
            + '<td><span class="font-mono text-[11px] text-slate-400">' + esc(c.client_code || '-') + '</span></td>'
            + '<td class="font-bold text-slate-800">' + esc(c.name || r.customer_name || '-') + '</td>'
            + '<td class="text-slate-600">' + esc(c.phone || '-') + '</td>'
            + '<td class="text-slate-600 text-[11px]">' + esc(c.email || '-') + '</td>'
            + '<td class="text-slate-600">' + esc(c.assigned_attorney || '-') + '</td>'
            + '<td><span class="' + (r.doc_type === '청구서' ? 'badge-inv' : 'badge-est') + '">'
                + esc(r.doc_type || '-') + '</span></td>'
            + '<td class="text-slate-600 text-[11px]">' + esc(quoteInfo) + '</td>'
            + '<td class="text-right font-bold text-slate-800">₩ ' + total.toLocaleString('ko-KR') + '</td>'
            + '<td>'
                + '<div class="flex items-center gap-1.5">'
                + '<span class="' + (isPaid ? 'badge-paid' : 'badge-unpaid') + '">' + esc(r.pay_status || '미납') + '</span>'
                + '<button class="toggle-btn" onclick="togglePay(\'' + r.id + '\',\'' + (r.pay_status||'미납') + '\')">'
                + (isPaid ? '↩미납' : '✓완납') + '</button>'
                + '</div>'
            + '</td>'
            + '<td class="text-[11px] text-green-600">' + paidDate + '</td>'
            + '<td>'
                + (shareLink
                    ? '<a href="' + shareLink + '" target="_blank" class="text-blue-500 hover:text-blue-700 text-[11px] font-bold"><i class="fa-solid fa-link mr-0.5"></i>보기</a>'
                    : '')
            + '</td>'
            + '</tr>';
    }).join('');
}

// ── 고객목록 렌더링 ──
function renderClients() {
    const q = (document.getElementById('search-input').value || '').toLowerCase();
    let rows = allClients;
    if (q) rows = rows.filter(function(c) { return (c.name||'').toLowerCase().includes(q); });
    if (typeFilter !== 'all') rows = rows.filter(function(c) { return c.client_type === typeFilter; });

    document.getElementById('row-count').innerText = rows.length;
    const tbody = document.getElementById('clients-tbody');

    if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="text-center py-10 text-slate-400 text-xs">데이터가 없습니다.</td></tr>';
        return;
    }

    // 고객별 발행건수 계산
    const countMap = {};
    allQuotes.forEach(function(q) { if (q.client_id) countMap[q.client_id] = (countMap[q.client_id]||0)+1; });

    const typeCls = { '법인': 'bg-blue-100 text-blue-600', '개인': 'bg-purple-100 text-purple-600' };

    tbody.innerHTML = rows.map(function(c) {
        const cnt = countMap[c.id] || 0;
        const regDate = c.created_at ? c.created_at.slice(0,10) : '-';
        const tc = typeCls[c.client_type] || 'bg-slate-100 text-slate-400';

        return '<tr>'
            + '<td><span class="font-mono text-[11px] text-slate-400">' + esc(c.client_code||'-') + '</span></td>'
            + '<td class="font-bold text-slate-800">' + esc(c.name) + '</td>'
            + '<td>' + (c.client_type ? '<span class="text-[10px] font-bold px-1.5 py-0.5 rounded ' + tc + '">' + esc(c.client_type) + '</span>' : '-') + '</td>'
            + '<td class="text-slate-600">' + esc(c.contact_name||'-') + '</td>'
            + '<td class="text-slate-600">' + esc(c.phone||'-') + '</td>'
            + '<td class="text-[11px] text-slate-600">' + esc(c.email||'-') + '</td>'
            + '<td class="text-slate-500">' + esc(c.business_no||'-') + '</td>'
            + '<td class="text-slate-600">' + esc(c.assigned_attorney||'-') + '</td>'
            + '<td class="text-center"><span class="font-bold ' + (cnt>0?'text-blue-600':'text-slate-300') + '">' + cnt + '</span></td>'
            + '<td>' + (c.is_active ? '<span class="text-[10px] text-green-600 font-bold">활성</span>' : '<span class="text-[10px] text-slate-400">비활성</span>') + '</td>'
            + '<td class="text-slate-400 text-[11px]">' + regDate + '</td>'
            + '<td>'
                + '<div class="flex gap-1">'
                + '<button onclick="openEditModal(\'' + c.id + '\')" class="toggle-btn"><i class="fa-solid fa-pencil mr-0.5"></i>수정</button>'
                + '<button onclick="goCreateQuote(\'' + c.id + '\')" class="toggle-btn text-blue-600 border-blue-200"><i class="fa-solid fa-file-invoice-dollar mr-0.5"></i>발행</button>'
                + '</div>'
            + '</td>'
            + '</tr>';
    }).join('');
}

// ── 합계 계산 ──
function calcTotal(qd) {
    if (!qd || !qd.items) return 0;
    var tFee = qd.items.reduce(function(s,i){ return s+(Number(i.feePrice)||0); }, 0);
    var tGov = qd.items.reduce(function(s,i){ return s+(Number(i.govPrice)||0); }, 0);
    return Math.round(tFee*1.1)+tGov;
}

// ── 납부상태 토글 ──
async function togglePay(quoteId, currentStatus) {
    if (!_supabase) return;
    const newStatus = currentStatus === '완납' ? '미납' : '완납';
    const { error } = await _supabase.from('quotes').update({
        pay_status: newStatus,
        paid_at: newStatus === '완납' ? new Date().toISOString() : null
    }).eq('id', quoteId);
    if (error) { alert('변경 실패: ' + error.message); return; }
    await loadQuotes();
}

// ── 견적서 작성 이동 ──
function goCreateQuote(clientId) {
    const c = allClients.find(function(x){ return x.id === clientId; });
    if (!c) return;
    const p = new URLSearchParams({ prefill_name: c.name, client_id: c.id });
    if (c.phone) p.set('prefill_phone', c.phone);
    if (c.email) p.set('prefill_email', c.email);
    window.location.href = 'index.html?' + p.toString();
}

// ── 모달 ──
function openNewModal() {
    editingId = null;
    document.getElementById('modal-title').innerText = '고객 등록';
    ['m-name','m-contact','m-phone','m-email','m-biz-no','m-attorney','m-memo']
        .forEach(function(id){ document.getElementById(id).value=''; });
    document.getElementById('m-type').value = '';
    showModal();
}

function openEditModal(clientId) {
    const c = allClients.find(function(x){ return x.id === clientId; });
    if (!c) return;
    editingId = c.id;
    document.getElementById('modal-title').innerText  = '고객 수정';
    document.getElementById('m-name').value           = c.name              || '';
    document.getElementById('m-type').value           = c.client_type       || '';
    document.getElementById('m-contact').value        = c.contact_name      || '';
    document.getElementById('m-phone').value          = c.phone             || '';
    document.getElementById('m-email').value          = c.email             || '';
    document.getElementById('m-biz-no').value         = c.business_no       || '';
    document.getElementById('m-attorney').value       = c.assigned_attorney || '';
    document.getElementById('m-memo').value           = c.memo              || '';
    showModal();
}

function showModal()  { document.getElementById('client-modal').style.display = 'flex'; }
function closeModal() { document.getElementById('client-modal').style.display = 'none'; }

async function saveClient() {
    const name = document.getElementById('m-name').value.trim();
    if (!name) { alert('고객명을 입력해주세요.'); return; }
    const payload = {
        name,
        client_type:       document.getElementById('m-type').value.trim()     || null,
        contact_name:      document.getElementById('m-contact').value.trim()  || null,
        phone:             document.getElementById('m-phone').value.trim()    || null,
        email:             document.getElementById('m-email').value.trim()    || null,
        business_no:       document.getElementById('m-biz-no').value.trim()   || null,
        assigned_attorney: document.getElementById('m-attorney').value.trim() || null,
        memo:              document.getElementById('m-memo').value.trim()     || null
    };
    let error;
    if (editingId) { ({ error } = await _supabase.from('clients').update(payload).eq('id', editingId)); }
    else           { ({ error } = await _supabase.from('clients').insert([payload])); }
    if (error) { alert('저장 실패: ' + error.message); return; }
    closeModal();
    await loadAll();
}

// ── HTML 이스케이프 ──
function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ── 모달 바깥 클릭 닫기 ──
document.getElementById('client-modal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

document.addEventListener('DOMContentLoaded', whenSupabaseReady);
</script>
</body>
</html>
